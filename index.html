<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FedPIE - Federal Procurement Intelligence Engine</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createClient } = supabase;

    // Initialize Supabase client
    const supabaseUrl = 'https://cwuxqohxoaspqfzfdbpl.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3dXhxb2h4b2FzcHFmemZkYnBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzE1NDYsImV4cCI6MjA3NTc0NzU0Nn0.g8WcEodFl2ET7_UGEh-Z13bUNWci4vXAXhpZ_wzhtuc';
    const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

    const BACKEND_URL = 'https://calm-narwhal-c32e6c.netlify.app/.netlify/functions/sam-proxy';
    const FPDS_PROXY_URL = 'https://calm-narwhal-c32e6c.netlify.app/.netlify/functions/fpds-proxy';
    const OPENAI_PROXY_URL = 'https://calm-narwhal-c32e6c.netlify.app/.netlify/functions/openai-proxy';

    // Agency code mapping for FPDS
    const AGENCY_CODES = {
      'DEPT OF THE INTERIOR': '1400',
      'DEPARTMENT OF THE INTERIOR': '1400',
      'INTERIOR': '1400',
      'VETERANS AFFAIRS, DEPARTMENT OF': '3600',
      'DEPARTMENT OF VETERANS AFFAIRS': '3600',
      'VETERANS AFFAIRS': '3600',
      'VA': '3600',
      'HEALTH AND HUMAN SERVICES, DEPARTMENT OF': '7500',
      'HHS': '7500',
      'AGRICULTURE, DEPARTMENT OF': '1200',
      'USDA': '1200',
      'HOMELAND SECURITY, DEPARTMENT OF': '7000',
      'DHS': '7000',
      'GENERAL SERVICES ADMINISTRATION': '4700',
      'GSA': '4700',
      'OFFICE OF PERSONNEL MANAGEMENT': '2400',
      'OPM': '2400',
      'SMALL BUSINESS ADMINISTRATION': '7300',
      'SBA': '7300',
      'ENVIRONMENTAL PROTECTION AGENCY': '6800',
      'EPA': '6800',
      'NATIONAL SCIENCE FOUNDATION': '4900',
      'NSF': '4900'
    };

    // Auth Components
    function AuthForm({ onSuccess }) {
      const [mode, setMode] = useState('signin');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
          if (mode === 'signup') {
            const { data, error } = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (error) throw error;
            alert('Check your email for the confirmation link!');
          } else {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
              email,
              password,
            });
            if (error) throw error;
            onSuccess();
          }
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">FedPIE</h1>
              <p className="text-gray-600">Federal Procurement Intelligence Engine</p>
            </div>

            <div className="flex gap-2 mb-6">
              <button
                onClick={() => setMode('signin')}
                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  mode === 'signin'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                Sign In
              </button>
              <button
                onClick={() => setMode('signup')}
                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  mode === 'signup'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                Sign Up
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="you@company.com"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Password
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength={6}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="••••••••"
                />
                {mode === 'signup' && (
                  <p className="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                )}
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors font-medium"
              >
                {loading ? 'Loading...' : mode === 'signin' ? 'Sign In' : 'Create Account'}
              </button>
            </form>

            <p className="text-xs text-gray-500 text-center mt-6">
              {mode === 'signup' 
                ? 'By signing up, you agree to our Terms of Service and Privacy Policy.'
                : 'Forgot your password? Contact support.'}
            </p>
          </div>
        </div>
      );
    }

    function CompanyProfile({ profile, onSave, onClose }) {
      const [formData, setFormData] = useState({
        ...profile,
        naicsCodesText: profile.naicsCodes?.join(', ') || '',
        targetAgenciesText: profile.targetAgencies?.join(', ') || ''
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        const naicsCodes = formData.naicsCodesText.split(',').map(c => c.trim()).filter(c => c);
        const targetAgencies = formData.targetAgenciesText.split(',').map(a => a.trim()).filter(a => a);
        
        const profileToSave = {
          companyName: formData.companyName,
          naicsCodes,
          setAsides: formData.setAsides,
          targetAgencies,
          minContractValue: formData.minContractValue,
          maxContractValue: formData.maxContractValue,
          minResponseDays: formData.minResponseDays
        };
        
        await onSave(profileToSave);
      };

      const toggleSetAside = (setAside) => {
        const current = formData.setAsides || [];
        const updated = current.includes(setAside)
          ? current.filter(s => s !== setAside)
          : [...current, setAside];
        setFormData({ ...formData, setAsides: updated });
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">Company Profile</h2>
              
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Company Name
                  </label>
                  <input
                    type="text"
                    value={formData.companyName}
                    onChange={(e) => setFormData({ ...formData, companyName: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Your Company Name"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    NAICS Codes (comma-separated)
                  </label>
                  <input
                    type="text"
                    value={formData.naicsCodesText}
                    onChange={(e) => setFormData({ ...formData, naicsCodesText: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="541519, 541511, 541512"
                  />
                  <p className="text-xs text-gray-500 mt-1">Enter the NAICS codes your company operates under</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Set-Aside Qualifications
                  </label>
                  <div className="space-y-2">
                    {['8(a)', 'Small Business', 'SDB', 'WOSB', 'SDVOSB', 'HUBZone', 'ANC'].map(setAside => (
                      <label key={setAside} className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={formData.setAsides?.includes(setAside)}
                          onChange={() => toggleSetAside(setAside)}
                          className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                        />
                        <span className="text-sm text-gray-700">{setAside}</span>
                      </label>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Target Agencies (comma-separated)
                  </label>
                  <input
                    type="text"
                    value={formData.targetAgenciesText}
                    onChange={(e) => setFormData({ ...formData, targetAgenciesText: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="DOI, VA, IHS, DOD"
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Min Contract Value ($)
                    </label>
                    <input
                      type="number"
                      value={formData.minContractValue}
                      onChange={(e) => setFormData({ ...formData, minContractValue: parseInt(e.target.value) || 0 })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Max Contract Value ($)
                    </label>
                    <input
                      type="number"
                      value={formData.maxContractValue}
                      onChange={(e) => setFormData({ ...formData, maxContractValue: parseInt(e.target.value) || 0 })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Minimum Response Days
                  </label>
                  <input
                    type="number"
                    value={formData.minResponseDays}
                    onChange={(e) => setFormData({ ...formData, minResponseDays: parseInt(e.target.value) || 0 })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p className="text-xs text-gray-500 mt-1">Minimum days needed to prepare a response</p>
                </div>

                <div className="flex gap-3 pt-4">
                  <button
                    type="submit"
                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save Profile
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    function FedPIE() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [opportunities, setOpportunities] = useState([]);
      const [allOpportunities, setAllOpportunities] = useState([]);
      const [filteredOpportunities, setFilteredOpportunities] = useState([]);
      const [totalCount, setTotalCount] = useState(0);
      const [fetchLoading, setFetchLoading] = useState(false);
      const [error, setError] = useState(null);
      const [profile, setProfile] = useState(null);
      const [showProfile, setShowProfile] = useState(false);
      const [filtersEnabled, setFiltersEnabled] = useState(true);
      const [servicesFilterEnabled, setServicesFilterEnabled] = useState(true);
      const [expandedScores, setExpandedScores] = useState({});
      const [showSearchOptions, setShowSearchOptions] = useState(false);
      
      // FPDS Intelligence State
      const [showFPDS, setShowFPDS] = useState(true);
      const [fpdsData, setFpdsData] = useState({});
      const [fpdsLoading, setFpdsLoading] = useState({});
      
      const [analyzingOpp, setAnalyzingOpp] = useState(null);
      const [analyses, setAnalyses] = useState({});
      const [showAnalysis, setShowAnalysis] = useState({});
      
      const [searchParams, setSearchParams] = useState({
        postedFrom: '2025-01-01',
        postedTo: '2025-12-31',
        limit: 100,
        keywords: ''
      });
      
      // Re-Compete Dashboard state
      const [currentView, setCurrentView] = useState('opportunities');
      const [recompeteContracts, setRecompeteContracts] = useState([]);
      const [recompeteLoading, setRecompeteLoading] = useState(false);
      const [trackedContracts, setTrackedContracts] = useState([]);
      const [groupBy, setGroupBy] = useState('urgency');
      const [filterTimeframe, setFilterTimeframe] = useState('all');
    
      // Check authentication status
      useEffect(() => {
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });

        const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
      }, []);

      // Load profile from Supabase when user logs in
      useEffect(() => {
        if (user) {
          loadProfileFromSupabase();
          loadTrackedContracts();
        }
      }, [user]);

      const getDefaultProfile = () => ({
        companyName: 'My Company',
        naicsCodes: [],
        setAsides: [],
        targetAgencies: [],
        minContractValue: 100000,
        maxContractValue: 50000000,
        minResponseDays: 7
      });

      const loadProfileFromSupabase = async () => {
        try {
          // Try to fetch existing profile
          const { data, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .maybeSingle();

          if (error) {
            console.error('Error fetching profile:', error);
            setProfile(getDefaultProfile());
            return;
          }

          if (data) {
            // Profile exists, use it
            setProfile({
              companyName: data.company_name || 'My Company',
              naicsCodes: data.naics_codes || [],
              setAsides: data.set_asides || [],
              targetAgencies: data.target_agencies || [],
              minContractValue: data.min_contract_value || 100000,
              maxContractValue: data.max_contract_value || 50000000,
              minResponseDays: data.min_response_days || 7
            });
          } else {
            // No profile exists yet, create default and insert it
            const defaultProfile = getDefaultProfile();
            
            const { error: insertError } = await supabaseClient
              .from('profiles')
              .insert({
                id: user.id,
                company_name: defaultProfile.companyName,
                naics_codes: defaultProfile.naicsCodes,
                set_asides: defaultProfile.setAsides,
                target_agencies: defaultProfile.targetAgencies,
                min_contract_value: defaultProfile.minContractValue,
                max_contract_value: defaultProfile.maxContractValue,
                min_response_days: defaultProfile.minResponseDays,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
              });

            if (insertError) {
              console.error('Error creating profile:', insertError);
            }
            
            setProfile(defaultProfile);
          }
        } catch (err) {
          console.error('Error loading profile:', err);
          setProfile(getDefaultProfile());
        }
      };

      const handleSaveProfile = async (newProfile) => {
        try {
          const { error } = await supabaseClient
            .from('profiles')
            .update({
              company_name: newProfile.companyName,
              naics_codes: newProfile.naicsCodes,
              set_asides: newProfile.setAsides,
              target_agencies: newProfile.targetAgencies,
              min_contract_value: newProfile.minContractValue,
              max_contract_value: newProfile.maxContractValue,
              min_response_days: newProfile.minResponseDays,
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);

          if (error) throw error;

          setProfile(newProfile);
          setShowProfile(false);
        } catch (err) {
          console.error('Error saving profile:', err);
          alert('Failed to save profile: ' + err.message);
        }
      };

      const handleSignOut = async () => {
        await supabaseClient.auth.signOut();
        setUser(null);
        setProfile(null);
      };

      // Re-Compete Dashboard Functions
      const loadTrackedContracts = async () => {
        try {
          const { data, error } = await supabaseClient
            .from('recompete_tracking')
            .select('*')
            .eq('user_id', user.id);

          if (error) throw error;
          setTrackedContracts(data || []);
        } catch (err) {
          console.error('Error loading tracked contracts:', err);
        }
      };

      const loadAllRecompetes = async () => {
        if (!profile || !profile.naicsCodes || profile.naicsCodes.length === 0) {
          alert('Please set up your company profile with NAICS codes first.');
          return;
        }

        setRecompeteLoading(true);
        const allContracts = [];

        try {
          for (const naics of profile.naicsCodes) {
            console.log(`Fetching contracts for NAICS ${naics}...`);
            
            const params = new URLSearchParams({ naics });
            const response = await fetch(`${FPDS_PROXY_URL}?${params}`);
            
            if (!response.ok) {
              console.error(`Failed to fetch NAICS ${naics}`);
              continue;
            }
            
            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
              const now = new Date();
              const twelveMonths = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
              
              const expiring = data.data.filter(c => {
                if (!c.completionDate) return false;
                const endDate = new Date(c.completionDate);
                return endDate > now && endDate <= twelveMonths;
              }).map(c => {
                const endDate = new Date(c.completionDate);
                const monthsUntil = Math.round((endDate - now) / (30 * 24 * 60 * 60 * 1000));
                return { ...c, monthsUntilExpiration: monthsUntil };
              });
              
              allContracts.push(...expiring);
            }
          }

          setRecompeteContracts(allContracts);
          console.log(`Found ${allContracts.length} expiring contracts`);
        } catch (err) {
          console.error('Error loading re-competes:', err);
          alert('Error loading re-compete data: ' + err.message);
        } finally {
          setRecompeteLoading(false);
        }
      };

      const trackContract = async (contract) => {
        try {
          const { error } = await supabaseClient
            .from('recompete_tracking')
            .insert({
              user_id: user.id,
              piid: contract.piid,
              naics_code: contract.naicsCode,
              agency_code: contract.agency,
              agency_name: contract.agencyName,
              incumbent_vendor: contract.vendorName,
              obligated_amount: contract.obligatedAmount,
              completion_date: contract.completionDate,
              months_until_expiration: contract.monthsUntilExpiration,
              description: contract.description,
              status: 'monitoring'
            });

          if (error) throw error;
          await loadTrackedContracts();
        } catch (err) {
          if (err.code === '23505') {
            alert('This contract is already being tracked');
          } else {
            console.error('Error tracking contract:', err);
            alert('Error tracking contract: ' + err.message);
          }
        }
      };

      const updateTrackingStatus = async (id, status) => {
        try {
          const { error } = await supabaseClient
            .from('recompete_tracking')
            .update({ status, updated_at: new Date().toISOString() })
            .eq('id', id);

          if (error) throw error;
          await loadTrackedContracts();
        } catch (err) {
          console.error('Error updating status:', err);
        }
      };

      const updateTrackingNotes = async (id, notes) => {
        try {
          const { error } = await supabaseClient
            .from('recompete_tracking')
            .update({ notes, updated_at: new Date().toISOString() })
            .eq('id', id);

          if (error) throw error;
          await loadTrackedContracts();
        } catch (err) {
          console.error('Error updating notes:', err);
        }
      };

      const untrackContract = async (id) => {
        if (!confirm('Stop tracking this contract?')) return;
        
        try {
          const { error } = await supabaseClient
            .from('recompete_tracking')
            .delete()
            .eq('id', id);

          if (error) throw error;
          await loadTrackedContracts();
        } catch (err) {
          console.error('Error untracking:', err);
        }
      };

      const isTracked = (piid) => {
        return trackedContracts.some(t => t.piid === piid);
      };

      const getTrackedData = (piid) => {
        return trackedContracts.find(t => t.piid === piid);
      };

      const groupContracts = (contracts) => {
        if (groupBy === 'urgency') {
          const urgent = contracts.filter(c => c.monthsUntilExpiration <= 3);
          const high = contracts.filter(c => c.monthsUntilExpiration > 3 && c.monthsUntilExpiration <= 6);
          const watch = contracts.filter(c => c.monthsUntilExpiration > 6);
          
          return [
            { label: '🔴 URGENT (0-3 months)', contracts: urgent },
            { label: '🟠 HIGH PRIORITY (3-6 months)', contracts: high },
            { label: '🟡 WATCH (6-12 months)', contracts: watch }
          ];
        } else if (groupBy === 'agency') {
          const grouped = {};
          contracts.forEach(c => {
            const agency = c.agencyName || 'Unknown Agency';
            if (!grouped[agency]) grouped[agency] = [];
            grouped[agency].push(c);
          });
          
          return Object.keys(grouped).map(agency => ({
            label: agency,
            contracts: grouped[agency]
          })).sort((a, b) => b.contracts.length - a.contracts.length);
        } else {
          const grouped = {};
          contracts.forEach(c => {
            const naics = c.naicsCode || 'Unknown';
            const desc = c.naicsDescription || '';
            const key = `${naics}${desc ? ' - ' + desc : ''}`;
            if (!grouped[key]) grouped[key] = [];
            grouped[key].push(c);
          });
          
          return Object.keys(grouped).map(naics => ({
            label: naics,
            contracts: grouped[naics]
          })).sort((a, b) => b.contracts.length - a.contracts.length);
        }
      };

      const filterContracts = (contracts) => {
        if (filterTimeframe === 'all') return contracts;
        
        const monthsMap = { '3mo': 3, '6mo': 6, '12mo': 12 };
        const maxMonths = monthsMap[filterTimeframe];
        
        return contracts.filter(c => c.monthsUntilExpiration <= maxMonths);
      };

      const calculateTotalValue = (contracts) => {
        return contracts.reduce((sum, c) => sum + (c.obligatedAmount || 0), 0);
      };

      // FPDS Intelligence Functions
      const getAgencyCode = (departmentName) => {
        if (!departmentName) return null;
        
        const deptUpper = departmentName.toUpperCase();
        
        for (const [key, code] of Object.entries(AGENCY_CODES)) {
          if (deptUpper.includes(key.toUpperCase())) {
            return code;
          }
        }
        
        if (deptUpper.includes('DEFENSE') || deptUpper.includes('DOD')) return '9700';
        if (deptUpper.includes('INTERIOR') || deptUpper.includes('DOI')) return '1400';
        if (deptUpper.includes('VETERANS') || deptUpper.includes('VA')) return '3600';
        if (deptUpper.includes('HEALTH') && deptUpper.includes('HUMAN')) return '7500';
        if (deptUpper.includes('HOMELAND') || deptUpper.includes('DHS')) return '7000';
        if (deptUpper.includes('AGRICULTURE') || deptUpper.includes('USDA')) return '1200';
        
        return null;
      };

      const fetchFPDSIntelligence = async (opp) => {
        const noticeId = opp.noticeId;
        
        if (fpdsData[noticeId] || fpdsLoading[noticeId]) {
          return;
        }

        setFpdsLoading(prev => ({ ...prev, [noticeId]: true }));

        try {
          const naicsCode = opp.naicsCode;
          
          if (!naicsCode) {
            setFpdsData(prev => ({
              ...prev,
              [noticeId]: { error: 'No NAICS code found for this opportunity', count: 0 }
            }));
            return;
          }
          
          const params = new URLSearchParams({ naics: naicsCode });
          const fpdsProxyUrl = `${FPDS_PROXY_URL}?${params}`;
          
          const response = await fetch(fpdsProxyUrl);
          
          if (!response.ok) {
            throw new Error(`Proxy returned status ${response.status}`);
          }
          
          const data = await response.json();
          
          if (data.success && data.data && data.data.length > 0) {
            const intelligence = analyzeContracts(data.data);
            setFpdsData(prev => ({
              ...prev,
              [noticeId]: intelligence
            }));
          } else {
            setFpdsData(prev => ({
              ...prev,
              [noticeId]: { 
                error: data.error || 'No contracts found for this NAICS code in the last 2 years', 
                count: 0 
              }
            }));
          }
        } catch (err) {
          console.error('FPDS fetch error:', err);
          setFpdsData(prev => ({
            ...prev,
            [noticeId]: { error: err.message, count: 0 }
          }));
        } finally {
          setFpdsLoading(prev => ({ ...prev, [noticeId]: false }));
        }
      };

      const analyzeContracts = (contracts) => {
        if (!contracts || contracts.length === 0) {
          return { count: 0, contracts: [] };
        }

        const values = contracts
          .map(c => c.obligatedAmount)
          .filter(v => v > 0);
        
        const avgValue = values.length > 0 
          ? values.reduce((a, b) => a + b, 0) / values.length 
          : 0;
        
        const medianValue = values.length > 0
          ? values.sort((a, b) => a - b)[Math.floor(values.length / 2)]
          : 0;
        
        const totalValue = values.reduce((a, b) => a + b, 0);
        
        const setAsideCount = contracts.filter(c => 
          c.setAside && (c.setAside.includes('8(A)') || c.setAside.includes('8A'))
        ).length;
        
        // Historical Trends Analysis
        const contractsByYear = {};
        contracts.forEach(c => {
          if (c.signedDate) {
            const year = new Date(c.signedDate).getFullYear();
            if (year >= 1990 && year <= 2025) {
              if (!contractsByYear[year]) {
                contractsByYear[year] = {
                  count: 0,
                  totalValue: 0,
                  contracts: []
                };
              }
              contractsByYear[year].count++;
              contractsByYear[year].totalValue += c.obligatedAmount || 0;
              contractsByYear[year].contracts.push(c);
            }
          }
        });
        
        const yearlyData = Object.keys(contractsByYear)
          .sort()
          .map(year => ({
            year: parseInt(year),
            count: contractsByYear[year].count,
            totalValue: contractsByYear[year].totalValue,
            avgValue: contractsByYear[year].totalValue / contractsByYear[year].count
          }));
        
        let trend = 'stable';
        let trendPercentage = 0;
        if (yearlyData.length >= 2) {
          const recentYears = yearlyData.slice(-3);
          if (recentYears.length >= 2) {
            const firstYear = recentYears[0].totalValue;
            const lastYear = recentYears[recentYears.length - 1].totalValue;
            
            if (firstYear > 0) {
              trendPercentage = ((lastYear - firstYear) / firstYear) * 100;
              
              if (trendPercentage > 15) {
                trend = 'growing';
              } else if (trendPercentage < -15) {
                trend = 'declining';
              } else {
                trend = 'stable';
              }
            }
          }
        }
        
        const vendorMap = {};
        contracts.forEach(c => {
          if (c.vendorName) {
            if (!vendorMap[c.vendorName]) {
              vendorMap[c.vendorName] = {
                name: c.vendorName,
                count: 0,
                totalValue: 0,
                contracts: []
              };
            }
            vendorMap[c.vendorName].count++;
            vendorMap[c.vendorName].totalValue += c.obligatedAmount || 0;
            vendorMap[c.vendorName].contracts.push(c);
          }
        });
        
        const topWinners = Object.values(vendorMap)
          .sort((a, b) => b.count - a.count)
          .slice(0, 5);
        
        const now = new Date();
        const threeMonths = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
        const sixMonths = new Date(now.getTime() + 180 * 24 * 60 * 60 * 1000);
        const twelveMonths = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
        
        const expiring3Months = contracts.filter(c => {
          if (!c.completionDate) return false;
          const endDate = new Date(c.completionDate);
          return endDate > now && endDate <= threeMonths;
        }).sort((a, b) => new Date(a.completionDate) - new Date(b.completionDate));
        
        const expiring6Months = contracts.filter(c => {
          if (!c.completionDate) return false;
          const endDate = new Date(c.completionDate);
          return endDate > threeMonths && endDate <= sixMonths;
        }).sort((a, b) => new Date(a.completionDate) - new Date(b.completionDate));
        
        const expiring12Months = contracts.filter(c => {
          if (!c.completionDate) return false;
          const endDate = new Date(c.completionDate);
          return endDate > sixMonths && endDate <= twelveMonths;
        }).sort((a, b) => new Date(a.completionDate) - new Date(b.completionDate));
        
        const addMonthsUntilExpiration = (contractList) => {
          return contractList.map(c => {
            const endDate = new Date(c.completionDate);
            const monthsUntil = Math.round((endDate - now) / (30 * 24 * 60 * 60 * 1000));
            return { ...c, monthsUntilExpiration: monthsUntil };
          });
        };

        return {
          count: contracts.length,
          avgValue: avgValue,
          medianValue: medianValue,
          totalValue: totalValue,
          setAsidePercent: contracts.length > 0 ? (setAsideCount / contracts.length * 100) : 0,
          topWinners: topWinners,
          historicalTrends: {
            yearlyData: yearlyData,
            trend: trend,
            trendPercentage: trendPercentage,
            yearsAnalyzed: yearlyData.length
          },
          recompeteAlerts: {
            expiring3Months: addMonthsUntilExpiration(expiring3Months),
            expiring6Months: addMonthsUntilExpiration(expiring6Months),
            expiring12Months: addMonthsUntilExpiration(expiring12Months),
            totalExpiring: expiring3Months.length + expiring6Months.length + expiring12Months.length
          },
          contracts: contracts
        };
      };

      const setQuickPreset = (preset) => {
        const today = new Date();
        let fromDate, toDate;
        
        switch(preset) {
          case 'last90':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 90);
            toDate = today;
            break;
          case 'last30':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 30);
            toDate = today;
            break;
          case '2025':
            fromDate = new Date('2025-01-01');
            const endOf2025 = new Date('2025-12-31');
            toDate = endOf2025 > today ? today : endOf2025;
            break;
        }
        
        const formatDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };
        
        setSearchParams({
          ...searchParams,
          postedFrom: formatDate(fromDate),
          postedTo: formatDate(toDate)
        });
      };

      const handleSearch = () => {
        const today = new Date();
        const endDate = new Date(searchParams.postedTo);
        
        if (endDate > today) {
          const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          };
          
          setSearchParams({
            ...searchParams,
            postedTo: formatDate(today)
          });
        }
        
        setShowSearchOptions(false);
        fetchOpportunities();
      };

      const toggleScoreBreakdown = (index) => {
        setExpandedScores(prev => ({
          ...prev,
          [index]: !prev[index]
        }));
      };

      const toggleAnalysisPanel = (noticeId) => {
        setShowAnalysis(prev => ({
          ...prev,
          [noticeId]: !prev[noticeId]
        }));
      };

      const getScoreColor = (score) => {
        if (score >= 80) return 'text-green-700 bg-green-100 border-green-300';
        if (score >= 60) return 'text-blue-700 bg-blue-100 border-blue-300';
        if (score >= 40) return 'text-yellow-700 bg-yellow-100 border-yellow-300';
        return 'text-gray-700 bg-gray-100 border-gray-300';
      };

      const getScoreTier = (score) => {
        if (score >= 80) return { emoji: '🏆', label: 'Tier 1: High Priority', color: 'text-green-700' };
        if (score >= 60) return { emoji: '⭐', label: 'Tier 2: Good Match', color: 'text-blue-700' };
        if (score >= 40) return { emoji: '📋', label: 'Tier 3: Consider', color: 'text-yellow-700' };
        return { emoji: '📄', label: 'Tier 4: Low Priority', color: 'text-gray-700' };
      };

      const analyzeWithAI = async (opp, index) => {
        if (analyses[opp.noticeId]) {
          toggleAnalysisPanel(opp.noticeId);
          return;
        }

        setAnalyzingOpp(opp.noticeId);
        
        try {
          const { score, breakdown } = calculateWinScore(opp);
          const tier = getScoreTier(score);
          
          const prompt = `You are analyzing a federal government contract opportunity for ${profile.companyName}.

COMPANY PROFILE:
- Company: ${profile.companyName}
- Set-Aside Qualifications: ${profile.setAsides?.join(', ') || 'None specified'}
- NAICS codes: ${profile.naicsCodes?.join(', ') || 'None specified'}
- Target agencies: ${profile.targetAgencies?.join(', ') || 'None specified'}
- Target contract value: $${(profile.minContractValue/1000000).toFixed(1)}M - $${(profile.maxContractValue/1000000).toFixed(1)}M

OPPORTUNITY DETAILS:
Title: ${opp.title}
Notice ID: ${opp.noticeId}
Type: ${opp.type || 'Not specified'}
Agency: ${opp.department || opp.fullParentPathName || 'Not specified'}
Set-Aside: ${opp.typeOfSetAside || 'Not specified'}
NAICS: ${opp.naicsCode || 'Not specified'}
Posted: ${new Date(opp.postedDate).toLocaleDateString()}
Deadline: ${new Date(opp.responseDeadLine).toLocaleDateString()}
Award Amount: ${opp.award?.amount ? '$' + opp.award.amount.toLocaleString() : 'Not specified'}
Description: ${opp.description || 'No description available'}

WIN PROBABILITY SCORE: ${score}/100 (${tier.label})

Please analyze this opportunity and provide a structured assessment. Return your response as valid JSON with these exact keys:

{
  "executiveSummary": "2-3 sentence overview of what this opportunity is and why it matters for this company",
  "keyRequirements": ["requirement 1", "requirement 2", "requirement 3"],
  "evaluationCriteria": "What will proposals be scored on and what matters most",
  "advantages": "Why this company is well-positioned, including specific qualifications",
  "redFlags": "Any concerns, deal-breakers, or competitive challenges (or 'None identified' if looks good)",
  "levelOfEffort": "Small/Medium/Large proposal expected, with estimated hours"
}

IMPORTANT: Respond ONLY with valid JSON. Do NOT include any markdown formatting, code blocks, or text outside the JSON object.`;

          const response = await fetch(OPENAI_PROXY_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `API error: ${response.status}`);
          }

          const data = await response.json();
          const aiResponse = data.choices[0].message.content;
          
          let analysis;
          try {
            const jsonText = aiResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            analysis = JSON.parse(jsonText);
          } catch (e) {
            analysis = {
              executiveSummary: "Analysis completed but response format was unexpected.",
              keyRequirements: ["Unable to parse structured requirements"],
              evaluationCriteria: "See raw response",
              advantages: "See raw response",
              redFlags: "See raw response",
              levelOfEffort: "Unable to determine",
              rawResponse: aiResponse
            };
          }

          setAnalyses(prev => ({
            ...prev,
            [opp.noticeId]: analysis
          }));
          
          setShowAnalysis(prev => ({
            ...prev,
            [opp.noticeId]: true
          }));
        } catch (err) {
          console.error('Analysis error:', err);
          alert(`Failed to analyze: ${err.message}`);
        } finally {
          setAnalyzingOpp(null);
        }
      };

      const calculateWinScore = (opp) => {
        let score = 0;
        const breakdown = {};

        if (opp.typeOfSetAside) {
          const setAside = opp.typeOfSetAside.toLowerCase();
          if (setAside.includes('8(a)')) {
            score += 30;
            breakdown.setAside = { points: 30, reason: '8(a) Set-Aside (sole source eligible)' };
          } else if (setAside.includes('native') || setAside.includes('anc')) {
            score += 25;
            breakdown.setAside = { points: 25, reason: 'ANC Set-Aside (special preferences)' };
          } else if (setAside.includes('small disadvantaged') || setAside.includes('sdb')) {
            score += 15;
            breakdown.setAside = { points: 15, reason: 'SDB Set-Aside' };
          } else if (setAside.includes('small business')) {
            score += 15;
            breakdown.setAside = { points: 15, reason: 'Small Business Set-Aside' };
          } else {
            breakdown.setAside = { points: 0, reason: 'No applicable set-aside' };
          }
        } else {
          breakdown.setAside = { points: 0, reason: 'Unrestricted competition' };
        }

        if (opp.naicsCode && profile.naicsCodes?.includes(opp.naicsCode)) {
          score += 20;
          breakdown.naics = { points: 20, reason: `NAICS ${opp.naicsCode} - Direct match` };
        } else {
          breakdown.naics = { points: 0, reason: 'NAICS not in your portfolio' };
        }

        if (opp.fullParentPathName && profile.targetAgencies?.length > 0) {
          const oppAgency = opp.fullParentPathName.toLowerCase();
          const tier1 = ['doi', 'va', 'ihs', 'veterans affairs', 'interior', 'indian health'];
          const isTier1 = tier1.some(a => oppAgency.includes(a));
          const matchedAgency = profile.targetAgencies.find(agency => 
            oppAgency.includes(agency.toLowerCase())
          );
          
          if (isTier1 && matchedAgency) {
            score += 20;
            breakdown.agency = { points: 20, reason: `Tier 1 Target Agency (${matchedAgency})` };
          } else if (matchedAgency) {
            score += 10;
            breakdown.agency = { points: 10, reason: `Target Agency (${matchedAgency})` };
          } else {
            breakdown.agency = { points: 0, reason: 'Not a target agency' };
          }
        } else {
          breakdown.agency = { points: 0, reason: 'Agency unknown' };
        }

        if (opp.award?.amount) {
          const amount = opp.award.amount;
          if (amount >= profile.minContractValue && amount <= profile.maxContractValue) {
            score += 15;
            breakdown.value = { points: 15, reason: 'In optimal value range' };
          } else if (amount < profile.minContractValue) {
            score += 5;
            breakdown.value = { points: 5, reason: 'Below target range (lower profit)' };
          } else {
            score += 5;
            breakdown.value = { points: 5, reason: 'Above target range (higher competition)' };
          }
        } else {
          breakdown.value = { points: 0, reason: 'Value not specified' };
        }

        if (opp.responseDeadLine) {
          const deadline = new Date(opp.responseDeadLine);
          const today = new Date();
          const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
          
          if (daysUntilDeadline >= 21) {
            score += 10;
            breakdown.responseTime = { points: 10, reason: `${daysUntilDeadline} days (comfortable timeline)` };
          } else if (daysUntilDeadline >= 14) {
            score += 7;
            breakdown.responseTime = { points: 7, reason: `${daysUntilDeadline} days (adequate time)` };
          } else if (daysUntilDeadline >= 7) {
            score += 4;
            breakdown.responseTime = { points: 4, reason: `${daysUntilDeadline} days (tight timeline)` };
          } else if (daysUntilDeadline > 0) {
            score += 0;
            breakdown.responseTime = { points: 0, reason: `${daysUntilDeadline} days (too rushed)` };
          } else {
            score += 0;
            breakdown.responseTime = { points: 0, reason: 'Deadline passed' };
          }
        } else {
          breakdown.responseTime = { points: 0, reason: 'No deadline specified' };
        }

        if (opp.typeOfSetAside && opp.typeOfSetAside.toLowerCase() !== 'none') {
          score += 5;
          breakdown.competition = { points: 5, reason: 'Limited competition (set-aside)' };
        } else {
          breakdown.competition = { points: 0, reason: 'Full and open competition' };
        }

        return { score, breakdown };
      };

      const calculateRelevance = (opp) => {
        const matches = {
          naics: false,
          setAside: false,
          agency: false,
          contractValue: false,
          responseTime: false
        };

        if (opp.naicsCode && profile.naicsCodes?.length > 0) {
          matches.naics = profile.naicsCodes.includes(opp.naicsCode);
        }

        if (opp.typeOfSetAside && profile.setAsides?.length > 0) {
          const oppSetAside = opp.typeOfSetAside.toLowerCase();
          matches.setAside = profile.setAsides.some(sa => {
            const normalized = sa.toLowerCase();
            return oppSetAside.includes(normalized) || 
                   (normalized === '8(a)' && oppSetAside.includes('8(a)')) ||
                   (normalized === 'sdb' && oppSetAside.includes('small disadvantaged')) ||
                   (normalized === 'anc' && oppSetAside.includes('native'));
          });
        }

        if (opp.fullParentPathName && profile.targetAgencies?.length > 0) {
          const oppAgency = opp.fullParentPathName.toLowerCase();
          matches.agency = profile.targetAgencies.some(agency => 
            oppAgency.includes(agency.toLowerCase())
          );
        }

        if (opp.award?.amount) {
          const amount = opp.award.amount;
          matches.contractValue = amount >= profile.minContractValue && 
                                  amount <= profile.maxContractValue;
        }

        if (opp.responseDeadLine) {
          const deadline = new Date(opp.responseDeadLine);
          const today = new Date();
          const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
          matches.responseTime = daysUntilDeadline >= profile.minResponseDays;
        }

        return matches;
      };

      const applyFilters = (opps) => {
        if (!filtersEnabled) return opps;

        const filtered = opps.filter(opp => {
          const matches = calculateRelevance(opp);
          
          const hasRelevanceMatch = matches.naics || matches.setAside || matches.agency;
          const passesValueFilter = !opp.award?.amount || matches.contractValue;
          const passesTimeFilter = !opp.responseDeadLine || matches.responseTime;
          
          return hasRelevanceMatch && passesValueFilter && passesTimeFilter;
        });

        return filtered.sort((a, b) => {
          const scoreA = calculateWinScore(a).score;
          const scoreB = calculateWinScore(b).score;
          return scoreB - scoreA;
        });
      };

      const isServicesContract = (opportunity) => {
        const naicsCode = opportunity.naicsCode;
        if (!naicsCode) return true;
        
        const naicsNum = parseInt(naicsCode);
        
        if (naicsNum >= 310000 && naicsNum <= 339999) {
          return false;
        }
        
        if (
          (naicsNum >= 510000 && naicsNum <= 519999) ||
          (naicsNum >= 540000 && naicsNum <= 549999) ||
          (naicsNum >= 560000 && naicsNum <= 569999) ||
          (naicsNum >= 610000 && naicsNum <= 619999) ||
          (naicsNum >= 620000 && naicsNum <= 629999) ||
          (naicsNum >= 710000 && naicsNum <= 719999) ||
          (naicsNum >= 810000 && naicsNum <= 819999)
        ) {
          return true;
        }
        
        return true;
      };

      const fetchOpportunities = async () => {
        setFetchLoading(true);
        setError(null);
        
        try {
          const formatDateForAPI = (dateStr) => {
            const [year, month, day] = dateStr.split('-');
            return `${month}/${day}/${year}`;
          };

          const params = new URLSearchParams({
            postedFrom: formatDateForAPI(searchParams.postedFrom),
            postedTo: formatDateForAPI(searchParams.postedTo),
            ptype: 'o',
            limit: searchParams.limit.toString()
          });

          const response = await fetch(`${BACKEND_URL}?${params}`);
          
          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          const allOpps = data.opportunitiesData || [];
          setTotalCount(allOpps.length);
          setAllOpportunities(allOpps);
          
          const displayOpps = servicesFilterEnabled 
            ? allOpps.filter(isServicesContract)
            : allOpps;
            
          setOpportunities(displayOpps);
          setFilteredOpportunities(applyFilters(displayOpps));
        } catch (err) {
          setError(err.message);
          console.error('Error:', err);
        } finally {
          setFetchLoading(false);
        }
      };

      useEffect(() => {
        if (user && profile) {
          fetchOpportunities();
        }
      }, [user, profile]);

      useEffect(() => {
        if (profile) {
          setFilteredOpportunities(applyFilters(opportunities));
        }
      }, [filtersEnabled, profile]);

      useEffect(() => {
        const displayOpps = servicesFilterEnabled 
          ? allOpportunities.filter(isServicesContract)
          : allOpportunities;
          
        setOpportunities(displayOpps);
        if (profile) {
          setFilteredOpportunities(applyFilters(displayOpps));
        }
      }, [servicesFilterEnabled]);

      const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
      };

      const formatCurrency = (value) => {
        if (!value) return 'Not specified';
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(value);
      };

      const getDeadlineCountdown = (deadlineString) => {
        if (!deadlineString) return null;
        
        const deadline = new Date(deadlineString);
        const today = new Date();
        const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
        
        let urgency, color, icon;
        
        if (daysLeft < 0) {
          urgency = 'EXPIRED';
          color = 'bg-gray-100 text-gray-600';
          icon = '⏰';
        } else if (daysLeft === 0) {
          urgency = 'DUE TODAY';
          color = 'bg-red-100 text-red-700 border-red-300 animate-pulse';
          icon = '🚨';
        } else if (daysLeft <= 3) {
          urgency = `${daysLeft} ${daysLeft === 1 ? 'DAY' : 'DAYS'} LEFT`;
          color = 'bg-red-100 text-red-700 border-red-300';
          icon = '🔴';
        } else if (daysLeft <= 7) {
          urgency = `${daysLeft} DAYS LEFT`;
          color = 'bg-orange-100 text-orange-700 border-orange-300';
          icon = '🟠';
        } else if (daysLeft <= 14) {
          urgency = `${daysLeft} DAYS LEFT`;
          color = 'bg-yellow-100 text-yellow-700 border-yellow-300';
          icon = '🟡';
        } else {
          urgency = `${daysLeft} DAYS LEFT`;
          color = 'bg-green-100 text-green-700 border-green-300';
          icon = '🟢';
        }
        
        return { daysLeft, urgency, color, icon };
      };

      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      if (!user) {
        return <AuthForm onSuccess={() => setLoading(false)} />;
      }

      if (!profile) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading your profile...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-8">
          {showProfile && (
            <CompanyProfile
              profile={profile}
              onSave={handleSaveProfile}
              onClose={() => setShowProfile(false)}
            />
          )}

          {showSearchOptions && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <div className="p-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-6">Search Options</h2>
                  
                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Quick Presets
                    </label>
                    <div className="flex gap-3 flex-wrap">
                      <button
                        onClick={() => setQuickPreset('last90')}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                      >
                        Last 90 Days
                      </button>
                      <button
                        onClick={() => setQuickPreset('last30')}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                      >
                        Last 30 Days
                      </button>
                      <button
                        onClick={() => setQuickPreset('2025')}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                      >
                        All of 2025
                      </button>
                    </div>
                  </div>

                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Custom Date Range
                    </label>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">From Date</label>
                        <input
                          type="date"
                          value={searchParams.postedFrom}
                          onChange={(e) => setSearchParams({ ...searchParams, postedFrom: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">To Date</label>
                        <input
                          type="date"
                          value={searchParams.postedTo}
                          onChange={(e) => setSearchParams({ ...searchParams, postedTo: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Maximum Results
                    </label>
                    <select
                      value={searchParams.limit}
                      onChange={(e) => setSearchParams({ ...searchParams, limit: parseInt(e.target.value) })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="50">50 results</option>
                      <option value="100">100 results</option>
                      <option value="250">250 results</option>
                      <option value="500">500 results</option>
                      <option value="1000">1000 results (max)</option>
                    </select>
                  </div>

                  <div className="flex gap-3 pt-4 border-t border-gray-200">
                    <button
                      onClick={handleSearch}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      🔍 Search SAM.gov
                    </button>
                    <button
                      onClick={() => setShowSearchOptions(false)}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="max-w-7xl mx-auto mb-8">
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <div className="flex items-start justify-between">
                <div>
                  <h1 className="text-3xl font-bold text-gray-900 mb-2">
                    FedPIE - Federal Procurement Intelligence Engine
                  </h1>
                  <p className="text-gray-600">
                    {profile?.companyName} - {user.email}
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowProfile(true)}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                  >
                    ⚙️ Company Profile
                  </button>
                  <button
                    onClick={handleSignOut}
                    className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium"
                  >
                    Sign Out
                  </button>
                </div>
              </div>

              <div className="mt-6 flex gap-2">
                <button
                  onClick={() => setCurrentView('opportunities')}
                  className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                    currentView === 'opportunities'
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  📋 Opportunities
                </button>
                <button
                  onClick={() => setCurrentView('recompete')}
                  className={`px-6 py-3 rounded-lg font-medium transition-colors ${
                    currentView === 'recompete'
                      ? 'bg-purple-600 text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  🚨 Re-Compete Dashboard
                </button>
              </div>
              
              <div className="mt-4 flex items-center gap-4 flex-wrap">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${fetchLoading ? 'bg-yellow-500 animate-pulse' : error ? 'bg-red-500' : 'bg-green-500'}`}></div>
                  <span className="text-sm text-gray-600">
                    {fetchLoading ? 'Fetching...' : error ? 'Connection Error' : 'Connected to SAM.gov'}
                  </span>
                </div>
                <button
                  onClick={() => setShowSearchOptions(!showSearchOptions)}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                >
                  🔍 Search Options
                </button>
                <button
                  onClick={fetchOpportunities}
                  disabled={fetchLoading}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors text-sm"
                >
                  Refresh Data
                </button>
                <button
                  onClick={() => setServicesFilterEnabled(!servicesFilterEnabled)}
                  className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                    servicesFilterEnabled 
                      ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {servicesFilterEnabled ? '✓ Services Only' : 'Show All Types'}
                </button>
                <button
                  onClick={() => setFiltersEnabled(!filtersEnabled)}
                  className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                    filtersEnabled 
                      ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {filtersEnabled ? '✓ Profile Filters' : 'Profile Filters Off'}
                </button>
                <button
                  onClick={() => setShowFPDS(!showFPDS)}
                  className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                    showFPDS 
                      ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {showFPDS ? '✓ FPDS Intelligence' : 'FPDS Intelligence Off'}
                </button>
              </div>
            </div>
          </div>

          {currentView === 'opportunities' ? (
            <div className="max-w-7xl mx-auto">
              {error && (
                <div className="mb-8">
                  <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h3 className="font-semibold text-red-900">Error Connecting to SAM.gov</h3>
                    <p className="text-sm text-red-700 mt-1">{error}</p>
                  </div>
                </div>
              )}

              {fetchLoading && (
                <div className="text-center py-12">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading opportunities from SAM.gov...</p>
                </div>
              )}

              {!fetchLoading && !error && (
                <>
                  <div className="mb-4">
                    <div className="flex items-center justify-between mb-2">
                      <div className="text-sm text-gray-600">
                        {filtersEnabled ? (
                          <>
                            Showing <span className="font-semibold">{filteredOpportunities.length} relevant opportunities</span>
                            {opportunities.length > filteredOpportunities.length && (
                              <span className="text-gray-500"> (filtered from {opportunities.length})</span>
                            )}
                          </>
                        ) : (
                          <>
                            Showing <span className="font-semibold">{opportunities.length} opportunities</span>
                            {totalCount > opportunities.length && servicesFilterEnabled && (
                              <span className="text-gray-500"> ({opportunities.length} services from {totalCount} total)</span>
                            )}
                          </>
                        )}
                      </div>
                    </div>
                    
                    <div className="text-xs text-gray-500 flex items-center gap-2">
                      <span>📅 Searching: {searchParams.postedFrom} to {searchParams.postedTo}</span>
                      <span>•</span>
                      <span>Limit: {searchParams.limit} results</span>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {(filtersEnabled ? filteredOpportunities : opportunities).map((opp, index) => {
                      const relevance = calculateRelevance(opp);
                      const { score, breakdown } = calculateWinScore(opp);
                      const tier = getScoreTier(score);
                      const scoreColor = getScoreColor(score);
                      const isAnalyzing = analyzingOpp === opp.noticeId;
                      const hasAnalysis = analyses[opp.noticeId];
                      const showingAnalysis = showAnalysis[opp.noticeId];
                      
                      const fpdsInfo = fpdsData[opp.noticeId];
                      const isFpdsLoading = fpdsLoading[opp.noticeId];
                      
                      return (
                        <div
                          key={index}
                          className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow"
                        >
                          {/* Opportunity content - keeping this brief for space */}
                          <div className="mb-3">
                            <div className="flex items-start gap-3 mb-2">
                              <h3 className="text-lg font-semibold text-gray-900 flex-1">
                                {opp.title || 'Untitled Opportunity'}
                              </h3>
                              
                              <div className="flex items-center gap-2">
                                <div className={`px-3 py-1.5 border-2 rounded-lg font-bold text-sm ${scoreColor}`}>
                                  {score}% Win
                                </div>
                                
                                <div className={`text-2xl ${tier.color}`} title={tier.label}>
                                  {tier.emoji}
                                </div>
                              </div>
                            </div>

                            <div className="text-sm text-gray-600 mb-4">
                              {opp.department || opp.fullParentPathName || 'N/A'} • {formatDate(opp.responseDeadLine)} • {formatCurrency(opp.award?.amount)}
                            </div>

                            {opp.noticeId && (
                              <a
                                href={`https://sam.gov/opp/${opp.noticeId}/view`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium inline-flex items-center gap-2"
                              >
                                View on SAM.gov
                              </a>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {(filtersEnabled ? filteredOpportunities : opportunities).length === 0 && (
                    <div className="text-center py-12 bg-white rounded-lg border border-gray-200">
                      <p className="text-gray-600">
                        {filtersEnabled 
                          ? 'No opportunities match your profile criteria.'
                          : 'No opportunities found'
                        }
                      </p>
                    </div>
                  )}
                </>
              )}
            </div>
          ) : (
            <div className="max-w-7xl mx-auto">
              <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <div className="flex items-center justify-between mb-4">
                  <div>
                    <h2 className="text-2xl font-bold text-gray-900">Re-Compete Intelligence</h2>
                    <p className="text-sm text-gray-600 mt-1">
                      Track expiring contracts across all your NAICS codes
                    </p>
                  </div>
                  <button
                    onClick={loadAllRecompetes}
                    disabled={recompeteLoading}
                    className="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 transition-colors font-medium flex items-center gap-2"
                  >
                    {recompeteLoading ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        Loading...
                      </>
                    ) : (
                      <>🔍 Load All Re-Competes</>
                    )}
                  </button>
                </div>

                {recompeteContracts.length > 0 && (
                  <>
                    <div className="grid grid-cols-4 gap-4 mb-6">
                      <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
                        <div className="text-sm text-blue-700 font-medium">Total Contracts</div>
                        <div className="text-3xl font-bold text-blue-900">{filterContracts(recompeteContracts).length}</div>
                      </div>
                      <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-4 border border-green-200">
                        <div className="text-sm text-green-700 font-medium">Total Value</div>
                        <div className="text-3xl font-bold text-green-900">{formatCurrency(calculateTotalValue(filterContracts(recompeteContracts)))}</div>
                      </div>
                      <div className="bg-gradient-to-br from-purple-50 to-pink-50 rounded-lg p-4 border border-purple-200">
                        <div className="text-sm text-purple-700 font-medium">Tracking</div>
                        <div className="text-3xl font-bold text-purple-900">{trackedContracts.length}</div>
                      </div>
                      <div className="bg-gradient-to-br from-orange-50 to-amber-50 rounded-lg p-4 border border-orange-200">
                        <div className="text-sm text-orange-700 font-medium">Pursuing</div>
                        <div className="text-3xl font-bold text-orange-900">
                          {trackedContracts.filter(t => t.status === 'pursuing').length}
                        </div>
                      </div>
                    </div>

                    <div className="flex items-center gap-4 flex-wrap">
                      <div>
                        <label className="text-sm font-medium text-gray-700 mr-2">Group by:</label>
                        <select
                          value={groupBy}
                          onChange={(e) => setGroupBy(e.target.value)}
                          className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                          <option value="urgency">Urgency</option>
                          <option value="agency">Agency</option>
                          <option value="naics">NAICS Code</option>
                        </select>
                      </div>

                      <div>
                        <label className="text-sm font-medium text-gray-700 mr-2">Timeframe:</label>
                        <select
                          value={filterTimeframe}
                          onChange={(e) => setFilterTimeframe(e.target.value)}
                          className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                          <option value="all">All (12 months)</option>
                          <option value="3mo">0-3 months</option>
                          <option value="6mo">0-6 months</option>
                          <option value="12mo">0-12 months</option>
                        </select>
                      </div>
                    </div>
                  </>
                )}
              </div>

              {recompeteContracts.length === 0 && !recompeteLoading && (
                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center">
                  <div className="text-6xl mb-4">🔍</div>
                  <h3 className="text-xl font-semibold text-gray-900 mb-2">
                    No Re-Compete Data Loaded
                  </h3>
                  <p className="text-gray-600 mb-6">
                    Click "Load All Re-Competes" to scan for expiring contracts across your NAICS codes
                  </p>
                </div>
              )}

              {groupContracts(filterContracts(recompeteContracts)).map((group, groupIdx) => (
                group.contracts.length > 0 && (
                  <div key={groupIdx} className="mb-6">
                    <div className="bg-gradient-to-r from-purple-100 to-indigo-100 rounded-lg p-4 mb-3 border-2 border-purple-200">
                      <div className="flex items-center justify-between">
                        <h3 className="text-xl font-bold text-purple-900">{group.label}</h3>
                        <div className="text-sm text-purple-700">
                          {group.contracts.length} contract{group.contracts.length !== 1 ? 's' : ''} • 
                          {formatCurrency(calculateTotalValue(group.contracts))}
                        </div>
                      </div>
                    </div>

                    <div className="space-y-3">
                      {group.contracts.map((contract, idx) => {
                        const tracked = getTrackedData(contract.piid);
                        const isBeingTracked = !!tracked;

                        return (
                          <div
                            key={idx}
                            className={`bg-white rounded-lg shadow-sm border-2 p-5 transition-all ${
                              isBeingTracked ? 'border-purple-300 bg-purple-50' : 'border-gray-200'
                            }`}
                          >
                            <div className="flex items-start justify-between mb-3">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                  <span className="text-2xl">
                                    {contract.monthsUntilExpiration <= 3 ? '🔴' : 
                                     contract.monthsUntilExpiration <= 6 ? '🟠' : '🟡'}
                                  </span>
                                  <div>
                                    <h4 className="font-bold text-gray-900 text-lg">
                                      {contract.vendorName || 'Unknown Vendor'}
                                    </h4>
                                    <div className="text-sm text-gray-600">
                                      Expires in {contract.monthsUntilExpiration} month{contract.monthsUntilExpiration !== 1 ? 's' : ''}
                                      {' • '}
                                      {formatDate(contract.completionDate)}
                                    </div>
                                  </div>
                                </div>
                              </div>

                              <div className="text-right">
                                <div className="text-2xl font-bold text-gray-900">
                                  {formatCurrency(contract.obligatedAmount)}
                                </div>
                                <div className="text-xs text-gray-500">
                                  PIID: {contract.piid}
                                </div>
                              </div>
                            </div>

                            {!isBeingTracked ? (
                              <button
                                onClick={() => trackContract(contract)}
                                className="w-full py-2 px-4 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium"
                              >
                                📌 Track This Contract
                              </button>
                            ) : (
                              <div className="space-y-3 bg-white rounded-lg p-4 border border-purple-200">
                                <div className="flex items-center gap-3">
                                  <label className="text-sm font-medium text-gray-700">Status:</label>
                                  <select
                                    value={tracked.status}
                                    onChange={(e) => updateTrackingStatus(tracked.id, e.target.value)}
                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                  >
                                    <option value="monitoring">👀 Monitoring</option>
                                    <option value="pursuing">🎯 Pursuing</option>
                                    <option value="pass">⏭️ Pass</option>
                                  </select>
                                  <button
                                    onClick={() => untrackContract(tracked.id)}
                                    className="px-3 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm"
                                  >
                                    ✕ Untrack
                                  </button>
                                </div>

                                <div>
                                  <label className="text-sm font-medium text-gray-700 block mb-1">Notes:</label>
                                  <textarea
                                    value={tracked.notes || ''}
                                    onChange={(e) => updateTrackingNotes(tracked.id, e.target.value)}
                                    placeholder="Add notes about decision makers, strategy, etc..."
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                                    rows={2}
                                  />
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )
              ))}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<FedPIE />, document.getElementById('root'));
  </script>
</body>
</html>