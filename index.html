<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FedPIE - Federal Procurement Intelligence Engine</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createClient } = supabase;

    // Initialize Supabase client
    const supabaseUrl = 'https://cwuxqohxoaspqfzfdbpl.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN3dXhxb2h4b2FzcHFmemZkYnBsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzE1NDYsImV4cCI6MjA3NTc0NzU0Nn0.g8WcEodFl2ET7_UGEh-Z13bUNWci4vXAXhpZ_wzhtuc';
    const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

    const BACKEND_URL = 'https://calm-narwhal-c32e6c.netlify.app/.netlify/functions/sam-proxy';
    const FPDS_PROXY_URL = 'https://calm-narwhal-c32e6c.netlify.app/.netlify/functions/fpds-proxy';
    const OPENAI_PROXY_URL = 'https://calm-narwhal-c32e6c.netlify.app/.netlify/functions/openai-proxy';

    // Agency code mapping for FPDS
    const AGENCY_CODES = {
      'DEPT OF THE INTERIOR': '1400',
      'DEPARTMENT OF THE INTERIOR': '1400',
      'INTERIOR': '1400',
      'VETERANS AFFAIRS, DEPARTMENT OF': '3600',
      'DEPARTMENT OF VETERANS AFFAIRS': '3600',
      'VETERANS AFFAIRS': '3600',
      'VA': '3600',
      'HEALTH AND HUMAN SERVICES, DEPARTMENT OF': '7500',
      'HHS': '7500',
      'AGRICULTURE, DEPARTMENT OF': '1200',
      'USDA': '1200',
      'HOMELAND SECURITY, DEPARTMENT OF': '7000',
      'DHS': '7000',
      'GENERAL SERVICES ADMINISTRATION': '4700',
      'GSA': '4700',
      'OFFICE OF PERSONNEL MANAGEMENT': '2400',
      'OPM': '2400',
      'SMALL BUSINESS ADMINISTRATION': '7300',
      'SBA': '7300',
      'ENVIRONMENTAL PROTECTION AGENCY': '6800',
      'EPA': '6800',
      'NATIONAL SCIENCE FOUNDATION': '4900',
      'NSF': '4900'
    };

    // Auth Components
    function AuthForm({ onSuccess }) {
      const [mode, setMode] = useState('signin');
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);

        try {
          if (mode === 'signup') {
            const { data, error } = await supabaseClient.auth.signUp({
              email,
              password,
            });
            if (error) throw error;
            alert('Check your email for the confirmation link!');
          } else {
            const { data, error } = await supabaseClient.auth.signInWithPassword({
              email,
              password,
            });
            if (error) throw error;
            onSuccess();
          }
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
            <div className="text-center mb-8">
              <h1 className="text-3xl font-bold text-gray-900 mb-2">FedPIE</h1>
              <p className="text-gray-600">Federal Procurement Intelligence Engine</p>
            </div>

            <div className="flex gap-2 mb-6">
              <button
                onClick={() => setMode('signin')}
                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  mode === 'signin'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                Sign In
              </button>
              <button
                onClick={() => setMode('signup')}
                className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${
                  mode === 'signup'
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                Sign Up
              </button>
            </div>

            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Email
                </label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  required
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="you@company.com"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Password
                </label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  required
                  minLength={6}
                  className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                />
                {mode === 'signup' && (
                  <p className="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                )}
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                  {error}
                </div>
              )}

              <button
                type="submit"
                disabled={loading}
                className="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors font-medium"
              >
                {loading ? 'Loading...' : mode === 'signin' ? 'Sign In' : 'Create Account'}
              </button>
            </form>

            <p className="text-xs text-gray-500 text-center mt-6">
              {mode === 'signup' 
                ? 'By signing up, you agree to our Terms of Service and Privacy Policy.'
                : 'Forgot your password? Contact support.'}
            </p>
          </div>
        </div>
      );
    }

    function CompanyProfile({ profile, onSave, onClose }) {
      const [formData, setFormData] = useState({
        ...profile,
        naicsCodesText: profile.naicsCodes?.join(', ') || '',
        targetAgenciesText: profile.targetAgencies?.join(', ') || ''
      });

      const handleSubmit = async (e) => {
        e.preventDefault();
        
        const naicsCodes = formData.naicsCodesText.split(',').map(c => c.trim()).filter(c => c);
        const targetAgencies = formData.targetAgenciesText.split(',').map(a => a.trim()).filter(a => a);
        
        const profileToSave = {
          companyName: formData.companyName,
          naicsCodes,
          setAsides: formData.setAsides,
          targetAgencies,
          minContractValue: formData.minContractValue,
          maxContractValue: formData.maxContractValue,
          minResponseDays: formData.minResponseDays
        };
        
        await onSave(profileToSave);
      };

      const toggleSetAside = (setAside) => {
        const current = formData.setAsides || [];
        const updated = current.includes(setAside)
          ? current.filter(s => s !== setAside)
          : [...current, setAside];
        setFormData({ ...formData, setAsides: updated });
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <h2 className="text-2xl font-bold text-gray-900 mb-6">Company Profile</h2>
              
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Company Name
                  </label>
                  <input
                    type="text"
                    value={formData.companyName}
                    onChange={(e) => setFormData({ ...formData, companyName: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Your Company Name"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    NAICS Codes (comma-separated)
                  </label>
                  <input
                    type="text"
                    value={formData.naicsCodesText}
                    onChange={(e) => setFormData({ ...formData, naicsCodesText: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="541519, 541511, 541512"
                  />
                  <p className="text-xs text-gray-500 mt-1">Enter the NAICS codes your company operates under</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Set-Aside Qualifications
                  </label>
                  <div className="space-y-2">
                    {['8(a)', 'Small Business', 'SDB', 'WOSB', 'SDVOSB', 'HUBZone', 'ANC'].map(setAside => (
                      <label key={setAside} className="flex items-center gap-2">
                        <input
                          type="checkbox"
                          checked={formData.setAsides?.includes(setAside)}
                          onChange={() => toggleSetAside(setAside)}
                          className="w-4 h-4 text-blue-600 border-gray-300 rounded"
                        />
                        <span className="text-sm text-gray-700">{setAside}</span>
                      </label>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Target Agencies (comma-separated)
                  </label>
                  <input
                    type="text"
                    value={formData.targetAgenciesText}
                    onChange={(e) => setFormData({ ...formData, targetAgenciesText: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="DOI, VA, IHS, DOD"
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Min Contract Value ($)
                    </label>
                    <input
                      type="number"
                      value={formData.minContractValue}
                      onChange={(e) => setFormData({ ...formData, minContractValue: parseInt(e.target.value) || 0 })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Max Contract Value ($)
                    </label>
                    <input
                      type="number"
                      value={formData.maxContractValue}
                      onChange={(e) => setFormData({ ...formData, maxContractValue: parseInt(e.target.value) || 0 })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Minimum Response Days
                  </label>
                  <input
                    type="number"
                    value={formData.minResponseDays}
                    onChange={(e) => setFormData({ ...formData, minResponseDays: parseInt(e.target.value) || 0 })}
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <p className="text-xs text-gray-500 mt-1">Minimum days needed to prepare a response</p>
                </div>

                <div className="flex gap-3 pt-4">
                  <button
                    type="submit"
                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                  >
                    Save Profile
                  </button>
                  <button
                    type="button"
                    onClick={onClose}
                    className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                  >
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    function FedPIE() {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [opportunities, setOpportunities] = useState([]);
      const [allOpportunities, setAllOpportunities] = useState([]);
      const [filteredOpportunities, setFilteredOpportunities] = useState([]);
      const [totalCount, setTotalCount] = useState(0);
      const [fetchLoading, setFetchLoading] = useState(false);
      const [error, setError] = useState(null);
      const [profile, setProfile] = useState(null);
      const [showProfile, setShowProfile] = useState(false);
      const [filtersEnabled, setFiltersEnabled] = useState(true);
      const [servicesFilterEnabled, setServicesFilterEnabled] = useState(true);
      const [expandedScores, setExpandedScores] = useState({});
      const [showSearchOptions, setShowSearchOptions] = useState(false);
      
      // FPDS Intelligence State
      const [showFPDS, setShowFPDS] = useState(true);
      const [fpdsData, setFpdsData] = useState({});
      const [fpdsLoading, setFpdsLoading] = useState({});
      
      const [analyzingOpp, setAnalyzingOpp] = useState(null);
      const [analyses, setAnalyses] = useState({});
      const [showAnalysis, setShowAnalysis] = useState({});
      
      const [searchParams, setSearchParams] = useState({
        postedFrom: '2025-01-01',
        postedTo: '2025-12-31',
        limit: 100,
        keywords: ''
      });

      // Check authentication status
      useEffect(() => {
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setLoading(false);
        });

        const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });

        return () => subscription.unsubscribe();
      }, []);

      // Load profile from Supabase when user logs in
      useEffect(() => {
        if (user) {
          loadProfileFromSupabase();
        }
      }, [user]);

      const loadProfileFromSupabase = async () => {
        try {
          const { data, error } = await supabaseClient
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();

          if (error) throw error;

          if (data) {
            setProfile({
              companyName: data.company_name || 'My Company',
              naicsCodes: data.naics_codes || [],
              setAsides: data.set_asides || [],
              targetAgencies: data.target_agencies || [],
              minContractValue: data.min_contract_value || 100000,
              maxContractValue: data.max_contract_value || 50000000,
              minResponseDays: data.min_response_days || 7
            });
          }
        } catch (err) {
          console.error('Error loading profile:', err);
        }
      };

      const handleSaveProfile = async (newProfile) => {
        try {
          const { error } = await supabaseClient
            .from('profiles')
            .update({
              company_name: newProfile.companyName,
              naics_codes: newProfile.naicsCodes,
              set_asides: newProfile.setAsides,
              target_agencies: newProfile.targetAgencies,
              min_contract_value: newProfile.minContractValue,
              max_contract_value: newProfile.maxContractValue,
              min_response_days: newProfile.minResponseDays,
              updated_at: new Date().toISOString()
            })
            .eq('id', user.id);

          if (error) throw error;

          setProfile(newProfile);
          setShowProfile(false);
        } catch (err) {
          console.error('Error saving profile:', err);
          alert('Failed to save profile: ' + err.message);
        }
      };

      const handleSignOut = async () => {
        await supabaseClient.auth.signOut();
        setUser(null);
        setProfile(null);
      };

      // FPDS Intelligence Functions
      const getAgencyCode = (departmentName) => {
        if (!departmentName) return null;
        
        const deptUpper = departmentName.toUpperCase();
        
        // Try exact match first
        for (const [key, code] of Object.entries(AGENCY_CODES)) {
          if (deptUpper.includes(key.toUpperCase())) {
            return code;
          }
        }
        
        // Try partial matches for common patterns
        if (deptUpper.includes('DEFENSE') || deptUpper.includes('DOD')) return '9700';
        if (deptUpper.includes('INTERIOR') || deptUpper.includes('DOI')) return '1400';
        if (deptUpper.includes('VETERANS') || deptUpper.includes('VA')) return '3600';
        if (deptUpper.includes('HEALTH') && deptUpper.includes('HUMAN')) return '7500';
        if (deptUpper.includes('HOMELAND') || deptUpper.includes('DHS')) return '7000';
        if (deptUpper.includes('AGRICULTURE') || deptUpper.includes('USDA')) return '1200';
        if (deptUpper.includes('ENERGY') || deptUpper.includes('DOE')) return '8900';
        if (deptUpper.includes('NASA')) return '8000';
        if (deptUpper.includes('JUSTICE') || deptUpper.includes('DOJ')) return '1500';
        if (deptUpper.includes('STATE DEPT')) return '1900';
        if (deptUpper.includes('TRANSPORTATION') || deptUpper.includes('DOT')) return '6900';
        if (deptUpper.includes('TREASURY')) return '2000';
        if (deptUpper.includes('COMMERCE')) return '1300';
        if (deptUpper.includes('LABOR') || deptUpper.includes('DOL')) return '1600';
        if (deptUpper.includes('GSA') || deptUpper.includes('GENERAL SERVICES')) return '4700';
        if (deptUpper.includes('EPA') || deptUpper.includes('ENVIRONMENTAL')) return '6800';
        if (deptUpper.includes('SBA') || deptUpper.includes('SMALL BUSINESS')) return '7300';
        if (deptUpper.includes('OPM') || deptUpper.includes('PERSONNEL MANAGEMENT')) return '2400';
        if (deptUpper.includes('NSF') || deptUpper.includes('SCIENCE FOUNDATION')) return '4900';
        
        return null;
      };

      const fetchFPDSIntelligence = async (opp) => {
        const noticeId = opp.noticeId;
        
        // Skip if already loaded or loading
        if (fpdsData[noticeId] || fpdsLoading[noticeId]) {
          return;
        }

        setFpdsLoading(prev => ({ ...prev, [noticeId]: true }));

        try {
          const naicsCode = opp.naicsCode;
          
          console.log('Fetching FPDS for:', {
            noticeId,
            naicsCode,
            department: opp.department,
            fullPath: opp.fullParentPathName
          });
          
          if (!naicsCode) {
            setFpdsData(prev => ({
              ...prev,
              [noticeId]: { error: 'No NAICS code found for this opportunity', count: 0 }
            }));
            return;
          }
          
          // Use Netlify proxy (now with https module)
          const params = new URLSearchParams({
            naics: naicsCode
          });
          
          const fpdsProxyUrl = `${FPDS_PROXY_URL}?${params}`;
          console.log('Calling FPDS proxy:', fpdsProxyUrl);
          
          const response = await fetch(fpdsProxyUrl);
          
          if (!response.ok) {
            throw new Error(`Proxy returned status ${response.status}`);
          }
          
          const data = await response.json();
          console.log('FPDS response:', data);
          
          if (data.success && data.data && data.data.length > 0) {
            const intelligence = analyzeContracts(data.data);
            setFpdsData(prev => ({
              ...prev,
              [noticeId]: intelligence
            }));
          } else {
            setFpdsData(prev => ({
              ...prev,
              [noticeId]: { 
                error: data.error || 'No contracts found for this NAICS code in the last 2 years', 
                count: 0 
              }
            }));
          }
        } catch (err) {
          console.error('FPDS fetch error:', err);
          setFpdsData(prev => ({
            ...prev,
            [noticeId]: { error: err.message, count: 0 }
          }));
        } finally {
          setFpdsLoading(prev => ({ ...prev, [noticeId]: false }));
        }
      };

      const analyzeContracts = (contracts) => {
        if (!contracts || contracts.length === 0) {
          return { count: 0, contracts: [] };
        }

        // Calculate statistics
        const values = contracts
          .map(c => c.obligatedAmount)
          .filter(v => v > 0);
        
        const avgValue = values.length > 0 
          ? values.reduce((a, b) => a + b, 0) / values.length 
          : 0;
        
        const medianValue = values.length > 0
          ? values.sort((a, b) => a - b)[Math.floor(values.length / 2)]
          : 0;
        
        const totalValue = values.reduce((a, b) => a + b, 0);
        
        // Count set-aside contracts
        const setAsideCount = contracts.filter(c => 
          c.setAside && (c.setAside.includes('8(A)') || c.setAside.includes('8A'))
        ).length;
        
        // Historical Trends Analysis
        const contractsByYear = {};
        contracts.forEach(c => {
          if (c.signedDate) {
            const year = new Date(c.signedDate).getFullYear();
            if (year >= 1990 && year <= 2025) { // Accept any contracts from 1990 onward
              if (!contractsByYear[year]) {
                contractsByYear[year] = {
                  count: 0,
                  totalValue: 0,
                  contracts: []
                };
              }
              contractsByYear[year].count++;
              contractsByYear[year].totalValue += c.obligatedAmount || 0;
              contractsByYear[year].contracts.push(c);
            }
          }
        });
        
        // Convert to sorted array
        const yearlyData = Object.keys(contractsByYear)
          .sort()
          .map(year => ({
            year: parseInt(year),
            count: contractsByYear[year].count,
            totalValue: contractsByYear[year].totalValue,
            avgValue: contractsByYear[year].totalValue / contractsByYear[year].count
          }));
        
        // Calculate trend
        let trend = 'stable';
        let trendPercentage = 0;
        if (yearlyData.length >= 2) {
          const recentYears = yearlyData.slice(-3); // Last 3 years
          if (recentYears.length >= 2) {
            const firstYear = recentYears[0].totalValue;
            const lastYear = recentYears[recentYears.length - 1].totalValue;
            
            if (firstYear > 0) {
              trendPercentage = ((lastYear - firstYear) / firstYear) * 100;
              
              if (trendPercentage > 15) {
                trend = 'growing';
              } else if (trendPercentage < -15) {
                trend = 'declining';
              } else {
                trend = 'stable';
              }
            }
          }
        }
        
        // Group by vendor
        const vendorMap = {};
        contracts.forEach(c => {
          if (c.vendorName) {
            if (!vendorMap[c.vendorName]) {
              vendorMap[c.vendorName] = {
                name: c.vendorName,
                count: 0,
                totalValue: 0,
                contracts: []
              };
            }
            vendorMap[c.vendorName].count++;
            vendorMap[c.vendorName].totalValue += c.obligatedAmount || 0;
            vendorMap[c.vendorName].contracts.push(c);
          }
        });
        
        // Get top 5 winners
        const topWinners = Object.values(vendorMap)
          .sort((a, b) => b.count - a.count)
          .slice(0, 5);
        
        // Find expiring contracts - categorize by timeframe
        const now = new Date();
        const threeMonths = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
        const sixMonths = new Date(now.getTime() + 180 * 24 * 60 * 60 * 1000);
        const twelveMonths = new Date(now.getTime() + 365 * 24 * 60 * 60 * 1000);
        
        const expiring3Months = contracts.filter(c => {
          if (!c.completionDate) return false;
          const endDate = new Date(c.completionDate);
          return endDate > now && endDate <= threeMonths;
        }).sort((a, b) => new Date(a.completionDate) - new Date(b.completionDate));
        
        const expiring6Months = contracts.filter(c => {
          if (!c.completionDate) return false;
          const endDate = new Date(c.completionDate);
          return endDate > threeMonths && endDate <= sixMonths;
        }).sort((a, b) => new Date(a.completionDate) - new Date(b.completionDate));
        
        const expiring12Months = contracts.filter(c => {
          if (!c.completionDate) return false;
          const endDate = new Date(c.completionDate);
          return endDate > sixMonths && endDate <= twelveMonths;
        }).sort((a, b) => new Date(a.completionDate) - new Date(b.completionDate));
        
        // Calculate months until expiration for each contract
        const addMonthsUntilExpiration = (contractList) => {
          return contractList.map(c => {
            const endDate = new Date(c.completionDate);
            const monthsUntil = Math.round((endDate - now) / (30 * 24 * 60 * 60 * 1000));
            return { ...c, monthsUntilExpiration: monthsUntil };
          });
        };

        return {
          count: contracts.length,
          avgValue: avgValue,
          medianValue: medianValue,
          totalValue: totalValue,
          setAsidePercent: contracts.length > 0 ? (setAsideCount / contracts.length * 100) : 0,
          topWinners: topWinners,
          historicalTrends: {
            yearlyData: yearlyData,
            trend: trend,
            trendPercentage: trendPercentage,
            yearsAnalyzed: yearlyData.length
          },
          recompeteAlerts: {
            expiring3Months: addMonthsUntilExpiration(expiring3Months),
            expiring6Months: addMonthsUntilExpiration(expiring6Months),
            expiring12Months: addMonthsUntilExpiration(expiring12Months),
            totalExpiring: expiring3Months.length + expiring6Months.length + expiring12Months.length
          },
          contracts: contracts
        };
      };

      const setQuickPreset = (preset) => {
        const today = new Date();
        let fromDate, toDate;
        
        switch(preset) {
          case 'last90':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 90);
            toDate = today;
            break;
          case 'last30':
            fromDate = new Date(today);
            fromDate.setDate(today.getDate() - 30);
            toDate = today;
            break;
          case '2025':
            fromDate = new Date('2025-01-01');
            const endOf2025 = new Date('2025-12-31');
            toDate = endOf2025 > today ? today : endOf2025;
            break;
        }
        
        const formatDate = (date) => {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };
        
        setSearchParams({
          ...searchParams,
          postedFrom: formatDate(fromDate),
          postedTo: formatDate(toDate)
        });
      };

      const handleSearch = () => {
        const today = new Date();
        const endDate = new Date(searchParams.postedTo);
        
        if (endDate > today) {
          const formatDate = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
          };
          
          setSearchParams({
            ...searchParams,
            postedTo: formatDate(today)
          });
        }
        
        setShowSearchOptions(false);
        fetchOpportunities();
      };

      const toggleScoreBreakdown = (index) => {
        setExpandedScores(prev => ({
          ...prev,
          [index]: !prev[index]
        }));
      };

      const toggleAnalysisPanel = (noticeId) => {
        setShowAnalysis(prev => ({
          ...prev,
          [noticeId]: !prev[noticeId]
        }));
      };

      const getScoreColor = (score) => {
        if (score >= 80) return 'text-green-700 bg-green-100 border-green-300';
        if (score >= 60) return 'text-blue-700 bg-blue-100 border-blue-300';
        if (score >= 40) return 'text-yellow-700 bg-yellow-100 border-yellow-300';
        return 'text-gray-700 bg-gray-100 border-gray-300';
      };

      const getScoreTier = (score) => {
        if (score >= 80) return { emoji: 'ðŸ†', label: 'Tier 1: High Priority', color: 'text-green-700' };
        if (score >= 60) return { emoji: 'â­', label: 'Tier 2: Good Match', color: 'text-blue-700' };
        if (score >= 40) return { emoji: 'ðŸ“‹', label: 'Tier 3: Consider', color: 'text-yellow-700' };
        return { emoji: 'ðŸ“„', label: 'Tier 4: Low Priority', color: 'text-gray-700' };
      };

      const analyzeWithAI = async (opp, index) => {
        if (analyses[opp.noticeId]) {
          toggleAnalysisPanel(opp.noticeId);
          return;
        }

        setAnalyzingOpp(opp.noticeId);
        
        try {
          const { score, breakdown } = calculateWinScore(opp);
          const tier = getScoreTier(score);
          
          const prompt = `You are analyzing a federal government contract opportunity for ${profile.companyName}.

COMPANY PROFILE:
- Company: ${profile.companyName}
- Set-Aside Qualifications: ${profile.setAsides?.join(', ') || 'None specified'}
- NAICS codes: ${profile.naicsCodes?.join(', ') || 'None specified'}
- Target agencies: ${profile.targetAgencies?.join(', ') || 'None specified'}
- Target contract value: $${(profile.minContractValue/1000000).toFixed(1)}M - $${(profile.maxContractValue/1000000).toFixed(1)}M

OPPORTUNITY DETAILS:
Title: ${opp.title}
Notice ID: ${opp.noticeId}
Type: ${opp.type || 'Not specified'}
Agency: ${opp.department || opp.fullParentPathName || 'Not specified'}
Set-Aside: ${opp.typeOfSetAside || 'Not specified'}
NAICS: ${opp.naicsCode || 'Not specified'}
Posted: ${new Date(opp.postedDate).toLocaleDateString()}
Deadline: ${new Date(opp.responseDeadLine).toLocaleDateString()}
Award Amount: ${opp.award?.amount ? '$' + opp.award.amount.toLocaleString() : 'Not specified'}
Description: ${opp.description || 'No description available'}

WIN PROBABILITY SCORE: ${score}/100 (${tier.label})

Please analyze this opportunity and provide a structured assessment. Return your response as valid JSON with these exact keys:

{
  "executiveSummary": "2-3 sentence overview of what this opportunity is and why it matters for this company",
  "keyRequirements": ["requirement 1", "requirement 2", "requirement 3"],
  "evaluationCriteria": "What will proposals be scored on and what matters most",
  "advantages": "Why this company is well-positioned, including specific qualifications",
  "redFlags": "Any concerns, deal-breakers, or competitive challenges (or 'None identified' if looks good)",
  "levelOfEffort": "Small/Medium/Large proposal expected, with estimated hours"
}

IMPORTANT: Respond ONLY with valid JSON. Do NOT include any markdown formatting, code blocks, or text outside the JSON object.`;

          const response = await fetch(OPENAI_PROXY_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ prompt })
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `API error: ${response.status}`);
          }

          const data = await response.json();
          const aiResponse = data.choices[0].message.content;
          
          let analysis;
          try {
            const jsonText = aiResponse.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            analysis = JSON.parse(jsonText);
          } catch (e) {
            analysis = {
              executiveSummary: "Analysis completed but response format was unexpected. See raw response below.",
              keyRequirements: ["Unable to parse structured requirements"],
              evaluationCriteria: "See raw response",
              advantages: "See raw response",
              redFlags: "See raw response",
              levelOfEffort: "Unable to determine",
              rawResponse: aiResponse
            };
          }

          setAnalyses(prev => ({
            ...prev,
            [opp.noticeId]: analysis
          }));
          
          setShowAnalysis(prev => ({
            ...prev,
            [opp.noticeId]: true
          }));
        } catch (err) {
          console.error('Analysis error:', err);
          alert(`Failed to analyze: ${err.message}`);
        } finally {
          setAnalyzingOpp(null);
        }
      };

      const calculateWinScore = (opp) => {
        let score = 0;
        const breakdown = {};

        if (opp.typeOfSetAside) {
          const setAside = opp.typeOfSetAside.toLowerCase();
          if (setAside.includes('8(a)')) {
            score += 30;
            breakdown.setAside = { points: 30, reason: '8(a) Set-Aside (sole source eligible)' };
          } else if (setAside.includes('native') || setAside.includes('anc')) {
            score += 25;
            breakdown.setAside = { points: 25, reason: 'ANC Set-Aside (special preferences)' };
          } else if (setAside.includes('small disadvantaged') || setAside.includes('sdb')) {
            score += 15;
            breakdown.setAside = { points: 15, reason: 'SDB Set-Aside' };
          } else if (setAside.includes('small business')) {
            score += 15;
            breakdown.setAside = { points: 15, reason: 'Small Business Set-Aside' };
          } else {
            breakdown.setAside = { points: 0, reason: 'No applicable set-aside' };
          }
        } else {
          breakdown.setAside = { points: 0, reason: 'Unrestricted competition' };
        }

        if (opp.naicsCode && profile.naicsCodes?.includes(opp.naicsCode)) {
          score += 20;
          breakdown.naics = { points: 20, reason: `NAICS ${opp.naicsCode} - Direct match` };
        } else {
          breakdown.naics = { points: 0, reason: 'NAICS not in your portfolio' };
        }

        if (opp.fullParentPathName && profile.targetAgencies?.length > 0) {
          const oppAgency = opp.fullParentPathName.toLowerCase();
          const tier1 = ['doi', 'va', 'ihs', 'veterans affairs', 'interior', 'indian health'];
          const isTier1 = tier1.some(a => oppAgency.includes(a));
          const matchedAgency = profile.targetAgencies.find(agency => 
            oppAgency.includes(agency.toLowerCase())
          );
          
          if (isTier1 && matchedAgency) {
            score += 20;
            breakdown.agency = { points: 20, reason: `Tier 1 Target Agency (${matchedAgency})` };
          } else if (matchedAgency) {
            score += 10;
            breakdown.agency = { points: 10, reason: `Target Agency (${matchedAgency})` };
          } else {
            breakdown.agency = { points: 0, reason: 'Not a target agency' };
          }
        } else {
          breakdown.agency = { points: 0, reason: 'Agency unknown' };
        }

        if (opp.award?.amount) {
          const amount = opp.award.amount;
          if (amount >= profile.minContractValue && amount <= profile.maxContractValue) {
            score += 15;
            breakdown.value = { points: 15, reason: 'In optimal value range' };
          } else if (amount < profile.minContractValue) {
            score += 5;
            breakdown.value = { points: 5, reason: 'Below target range (lower profit)' };
          } else {
            score += 5;
            breakdown.value = { points: 5, reason: 'Above target range (higher competition)' };
          }
        } else {
          breakdown.value = { points: 0, reason: 'Value not specified' };
        }

        if (opp.responseDeadLine) {
          const deadline = new Date(opp.responseDeadLine);
          const today = new Date();
          const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
          
          if (daysUntilDeadline >= 21) {
            score += 10;
            breakdown.responseTime = { points: 10, reason: `${daysUntilDeadline} days (comfortable timeline)` };
          } else if (daysUntilDeadline >= 14) {
            score += 7;
            breakdown.responseTime = { points: 7, reason: `${daysUntilDeadline} days (adequate time)` };
          } else if (daysUntilDeadline >= 7) {
            score += 4;
            breakdown.responseTime = { points: 4, reason: `${daysUntilDeadline} days (tight timeline)` };
          } else if (daysUntilDeadline > 0) {
            score += 0;
            breakdown.responseTime = { points: 0, reason: `${daysUntilDeadline} days (too rushed)` };
          } else {
            score += 0;
            breakdown.responseTime = { points: 0, reason: 'Deadline passed' };
          }
        } else {
          breakdown.responseTime = { points: 0, reason: 'No deadline specified' };
        }

        if (opp.typeOfSetAside && opp.typeOfSetAside.toLowerCase() !== 'none') {
          score += 5;
          breakdown.competition = { points: 5, reason: 'Limited competition (set-aside)' };
        } else {
          breakdown.competition = { points: 0, reason: 'Full and open competition' };
        }

        return { score, breakdown };
      };

      const calculateRelevance = (opp) => {
        const matches = {
          naics: false,
          setAside: false,
          agency: false,
          contractValue: false,
          responseTime: false
        };

        if (opp.naicsCode && profile.naicsCodes?.length > 0) {
          matches.naics = profile.naicsCodes.includes(opp.naicsCode);
        }

        if (opp.typeOfSetAside && profile.setAsides?.length > 0) {
          const oppSetAside = opp.typeOfSetAside.toLowerCase();
          matches.setAside = profile.setAsides.some(sa => {
            const normalized = sa.toLowerCase();
            return oppSetAside.includes(normalized) || 
                   (normalized === '8(a)' && oppSetAside.includes('8(a)')) ||
                   (normalized === 'sdb' && oppSetAside.includes('small disadvantaged')) ||
                   (normalized === 'anc' && oppSetAside.includes('native'));
          });
        }

        if (opp.fullParentPathName && profile.targetAgencies?.length > 0) {
          const oppAgency = opp.fullParentPathName.toLowerCase();
          matches.agency = profile.targetAgencies.some(agency => 
            oppAgency.includes(agency.toLowerCase())
          );
        }

        if (opp.award?.amount) {
          const amount = opp.award.amount;
          matches.contractValue = amount >= profile.minContractValue && 
                                  amount <= profile.maxContractValue;
        }

        if (opp.responseDeadLine) {
          const deadline = new Date(opp.responseDeadLine);
          const today = new Date();
          const daysUntilDeadline = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
          matches.responseTime = daysUntilDeadline >= profile.minResponseDays;
        }

        return matches;
      };

      const applyFilters = (opps) => {
        if (!filtersEnabled) return opps;

        const filtered = opps.filter(opp => {
          const matches = calculateRelevance(opp);
          
          const hasRelevanceMatch = matches.naics || matches.setAside || matches.agency;
          const passesValueFilter = !opp.award?.amount || matches.contractValue;
          const passesTimeFilter = !opp.responseDeadLine || matches.responseTime;
          
          return hasRelevanceMatch && passesValueFilter && passesTimeFilter;
        });

        return filtered.sort((a, b) => {
          const scoreA = calculateWinScore(a).score;
          const scoreB = calculateWinScore(b).score;
          return scoreB - scoreA;
        });
      };

      const isServicesContract = (opportunity) => {
        const naicsCode = opportunity.naicsCode;
        if (!naicsCode) return true;
        
        const naicsNum = parseInt(naicsCode);
        
        if (naicsNum >= 310000 && naicsNum <= 339999) {
          return false;
        }
        
        if (
          (naicsNum >= 510000 && naicsNum <= 519999) ||
          (naicsNum >= 540000 && naicsNum <= 549999) ||
          (naicsNum >= 560000 && naicsNum <= 569999) ||
          (naicsNum >= 610000 && naicsNum <= 619999) ||
          (naicsNum >= 620000 && naicsNum <= 629999) ||
          (naicsNum >= 710000 && naicsNum <= 719999) ||
          (naicsNum >= 810000 && naicsNum <= 819999)
        ) {
          return true;
        }
        
        return true;
      };

      const fetchOpportunities = async () => {
        setFetchLoading(true);
        setError(null);
        
        try {
          const formatDateForAPI = (dateStr) => {
            const [year, month, day] = dateStr.split('-');
            return `${month}/${day}/${year}`;
          };

          const params = new URLSearchParams({
            postedFrom: formatDateForAPI(searchParams.postedFrom),
            postedTo: formatDateForAPI(searchParams.postedTo),
            ptype: 'o',
            limit: searchParams.limit.toString()
          });

          const response = await fetch(`${BACKEND_URL}?${params}`);
          
          if (!response.ok) {
            throw new Error(`API Error: ${response.status} ${response.statusText}`);
          }
          
          const data = await response.json();
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          const allOpps = data.opportunitiesData || [];
          setTotalCount(allOpps.length);
          setAllOpportunities(allOpps);
          
          const displayOpps = servicesFilterEnabled 
            ? allOpps.filter(isServicesContract)
            : allOpps;
            
          setOpportunities(displayOpps);
          setFilteredOpportunities(applyFilters(displayOpps));
        } catch (err) {
          setError(err.message);
          console.error('Error:', err);
        } finally {
          setFetchLoading(false);
        }
      };

      useEffect(() => {
        if (user && profile) {
          fetchOpportunities();
        }
      }, [user, profile]);

      useEffect(() => {
        if (profile) {
          setFilteredOpportunities(applyFilters(opportunities));
        }
      }, [filtersEnabled, profile]);

      useEffect(() => {
        const displayOpps = servicesFilterEnabled 
          ? allOpportunities.filter(isServicesContract)
          : allOpportunities;
          
        setOpportunities(displayOpps);
        if (profile) {
          setFilteredOpportunities(applyFilters(displayOpps));
        }
      }, [servicesFilterEnabled]);

      const formatDate = (dateString) => {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
      };

      const formatCurrency = (value) => {
        if (!value) return 'Not specified';
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        }).format(value);
      };

      const getDeadlineCountdown = (deadlineString) => {
        if (!deadlineString) return null;
        
        const deadline = new Date(deadlineString);
        const today = new Date();
        const daysLeft = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
        
        let urgency, color, icon;
        
        if (daysLeft < 0) {
          urgency = 'EXPIRED';
          color = 'bg-gray-100 text-gray-600';
          icon = 'â°';
        } else if (daysLeft === 0) {
          urgency = 'DUE TODAY';
          color = 'bg-red-100 text-red-700 border-red-300 animate-pulse';
          icon = 'ðŸš¨';
        } else if (daysLeft <= 3) {
          urgency = `${daysLeft} ${daysLeft === 1 ? 'DAY' : 'DAYS'} LEFT`;
          color = 'bg-red-100 text-red-700 border-red-300';
          icon = 'ðŸ”´';
        } else if (daysLeft <= 7) {
          urgency = `${daysLeft} DAYS LEFT`;
          color = 'bg-orange-100 text-orange-700 border-orange-300';
          icon = 'ðŸŸ ';
        } else if (daysLeft <= 14) {
          urgency = `${daysLeft} DAYS LEFT`;
          color = 'bg-yellow-100 text-yellow-700 border-yellow-300';
          icon = 'ðŸŸ¡';
        } else {
          urgency = `${daysLeft} DAYS LEFT`;
          color = 'bg-green-100 text-green-700 border-green-300';
          icon = 'ðŸŸ¢';
        }
        
        return { daysLeft, urgency, color, icon };
      };

      // Show auth screen if not logged in
      if (loading) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading...</p>
            </div>
          </div>
        );
      }

      if (!user) {
        return <AuthForm onSuccess={() => setLoading(false)} />;
      }

      if (!profile) {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading your profile...</p>
            </div>
          </div>
        );
      }

      // Main app UI
      return (
        <div className="min-h-screen bg-gray-50 p-8">
          {showProfile && (
            <CompanyProfile
              profile={profile}
              onSave={handleSaveProfile}
              onClose={() => setShowProfile(false)}
            />
          )}

          {showSearchOptions && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full">
                <div className="p-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-6">Search Options</h2>
                  
                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Quick Presets
                    </label>
                    <div className="flex gap-3 flex-wrap">
                      <button
                        onClick={() => setQuickPreset('last90')}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                      >
                        Last 90 Days
                      </button>
                      <button
                        onClick={() => setQuickPreset('last30')}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                      >
                        Last 30 Days
                      </button>
                      <button
                        onClick={() => setQuickPreset('2025')}
                        className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors font-medium"
                      >
                        All of 2025
                      </button>
                    </div>
                  </div>

                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Custom Date Range
                    </label>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">From Date</label>
                        <input
                          type="date"
                          value={searchParams.postedFrom}
                          onChange={(e) => setSearchParams({ ...searchParams, postedFrom: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                      <div>
                        <label className="block text-xs text-gray-600 mb-1">To Date</label>
                        <input
                          type="date"
                          value={searchParams.postedTo}
                          onChange={(e) => setSearchParams({ ...searchParams, postedTo: e.target.value })}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>
                    </div>
                  </div>

                  <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-3">
                      Maximum Results
                    </label>
                    <select
                      value={searchParams.limit}
                      onChange={(e) => setSearchParams({ ...searchParams, limit: parseInt(e.target.value) })}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="50">50 results</option>
                      <option value="100">100 results</option>
                      <option value="250">250 results</option>
                      <option value="500">500 results</option>
                      <option value="1000">1000 results (max)</option>
                    </select>
                  </div>

                  <div className="flex gap-3 pt-4 border-t border-gray-200">
                    <button
                      onClick={handleSearch}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                    >
                      ðŸ” Search SAM.gov
                    </button>
                    <button
                      onClick={() => setShowSearchOptions(false)}
                      className="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          <div className="max-w-7xl mx-auto mb-8">
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <div className="flex items-start justify-between">
                <div>
                  <h1 className="text-3xl font-bold text-gray-900 mb-2">
                    FedPIE - Federal Procurement Intelligence Engine
                  </h1>
                  <p className="text-gray-600">
                    {profile?.companyName} - {user.email}
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => setShowProfile(true)}
                    className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium"
                  >
                    âš™ï¸ Company Profile
                  </button>
                  <button
                    onClick={handleSignOut}
                    className="px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium"
                  >
                    Sign Out
                  </button>
                </div>
              </div>
              
              <div className="mt-4 flex items-center gap-4 flex-wrap">
                <div className="flex items-center gap-2">
                  <div className={`w-3 h-3 rounded-full ${fetchLoading ? 'bg-yellow-500 animate-pulse' : error ? 'bg-red-500' : 'bg-green-500'}`}></div>
                  <span className="text-sm text-gray-600">
                    {fetchLoading ? 'Fetching...' : error ? 'Connection Error' : 'Connected to SAM.gov'}
                  </span>
                </div>
                <button
                  onClick={() => setShowSearchOptions(!showSearchOptions)}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium"
                >
                  ðŸ” Search Options
                </button>
                <button
                  onClick={fetchOpportunities}
                  disabled={fetchLoading}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 transition-colors text-sm"
                >
                  Refresh Data
                </button>
                <button
                  onClick={() => setServicesFilterEnabled(!servicesFilterEnabled)}
                  className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                    servicesFilterEnabled 
                      ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {servicesFilterEnabled ? 'âœ“ Services Only' : 'Show All Types'}
                </button>
                <button
                  onClick={() => setFiltersEnabled(!filtersEnabled)}
                  className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                    filtersEnabled 
                      ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {filtersEnabled ? 'âœ“ Profile Filters' : 'Profile Filters Off'}
                </button>
                <button
                  onClick={() => setShowFPDS(!showFPDS)}
                  className={`px-4 py-2 rounded-lg transition-colors text-sm font-medium ${
                    showFPDS 
                      ? 'bg-purple-100 text-purple-700 hover:bg-purple-200' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {showFPDS ? 'âœ“ FPDS Intelligence' : 'FPDS Intelligence Off'}
                </button>
              </div>
            </div>
          </div>

          {error && (
            <div className="max-w-7xl mx-auto mb-8">
              <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 className="font-semibold text-red-900">Error Connecting to SAM.gov</h3>
                <p className="text-sm text-red-700 mt-1">{error}</p>
              </div>
            </div>
          )}

          {fetchLoading && (
            <div className="max-w-7xl mx-auto text-center py-12">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Loading opportunities from SAM.gov...</p>
            </div>
          )}

          {!fetchLoading && !error && (
            <div className="max-w-7xl mx-auto">
              <div className="mb-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-sm text-gray-600">
                    {filtersEnabled ? (
                      <>
                        Showing <span className="font-semibold">{filteredOpportunities.length} relevant opportunities</span>
                        {opportunities.length > filteredOpportunities.length && (
                          <span className="text-gray-500"> (filtered from {opportunities.length})</span>
                        )}
                      </>
                    ) : (
                      <>
                        Showing <span className="font-semibold">{opportunities.length} opportunities</span>
                        {totalCount > opportunities.length && servicesFilterEnabled && (
                          <span className="text-gray-500"> ({opportunities.length} services from {totalCount} total)</span>
                        )}
                      </>
                    )}
                  </div>
                </div>
                
                <div className="text-xs text-gray-500 flex items-center gap-2">
                  <span>ðŸ“… Searching: {searchParams.postedFrom} to {searchParams.postedTo}</span>
                  <span>â€¢</span>
                  <span>Limit: {searchParams.limit} results</span>
                </div>
              </div>

              <div className="space-y-4">
                {(filtersEnabled ? filteredOpportunities : opportunities).map((opp, index) => {
                  const relevance = calculateRelevance(opp);
                  const { score, breakdown } = calculateWinScore(opp);
                  const tier = getScoreTier(score);
                  const scoreColor = getScoreColor(score);
                  const isAnalyzing = analyzingOpp === opp.noticeId;
                  const hasAnalysis = analyses[opp.noticeId];
                  const showingAnalysis = showAnalysis[opp.noticeId];
                  
                  const fpdsInfo = fpdsData[opp.noticeId];
                  const isFpdsLoading = fpdsLoading[opp.noticeId];
                  
                  return (
                    <div
                      key={index}
                      className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow"
                    >
                      <div className="mb-3">
                        <div className="flex items-start gap-3 mb-2">
                          <h3 className="text-lg font-semibold text-gray-900 flex-1">
                            {opp.title || 'Untitled Opportunity'}
                          </h3>
                          
                          <div className="flex items-center gap-2">
                            <div className={`px-3 py-1.5 border-2 rounded-lg font-bold text-sm ${scoreColor}`}>
                              {score}% Win
                            </div>
                            
                            <div className={`text-2xl ${tier.color}`} title={tier.label}>
                              {tier.emoji}
                            </div>
                          </div>
                        </div>
                        
                        <div className="mb-2">
                          <span className={`text-sm font-medium ${tier.color}`}>
                            {tier.label}
                          </span>
                        </div>

                        <div className="flex gap-2 mb-2">
                          <button
                            onClick={() => toggleScoreBreakdown(index)}
                            className="text-sm text-blue-600 hover:text-blue-800 underline"
                          >
                            {expandedScores[index] ? 'â–¼ Hide' : 'â–¶ Show'} Score Breakdown
                          </button>
                          
                          <span className="text-gray-300">|</span>
                          
                          <button
                            onClick={() => analyzeWithAI(opp, index)}
                            disabled={isAnalyzing}
                            className={`text-sm font-medium underline ${
                              isAnalyzing 
                                ? 'text-gray-400 cursor-wait' 
                                : hasAnalysis 
                                  ? 'text-purple-600 hover:text-purple-800' 
                                  : 'text-purple-600 hover:text-purple-800'
                            }`}
                          >
                            {isAnalyzing ? 'âœ¨ Analyzing...' : hasAnalysis ? 'âœ¨ View AI Analysis' : 'âœ¨ Analyze with AI'}
                          </button>
                          
                          {showFPDS && !fpdsInfo && !isFpdsLoading && (
                            <>
                              <span className="text-gray-300">|</span>
                              <button
                                onClick={() => fetchFPDSIntelligence(opp)}
                                className="text-sm text-indigo-600 hover:text-indigo-800 underline font-medium"
                              >
                                ðŸ” Load FPDS Intelligence
                              </button>
                            </>
                          )}
                        </div>

                        {expandedScores[index] && (
                          <div className="bg-gray-50 rounded-lg p-4 mb-3 space-y-2">
                            <div className="font-semibold text-sm text-gray-700 mb-2">Why this scored {score}%:</div>
                            {Object.entries(breakdown).map(([key, data]) => (
                              <div key={key} className="flex items-center justify-between text-sm">
                                <span className="text-gray-700">{data.reason}</span>
                                <span className={`font-semibold ${data.points > 0 ? 'text-green-600' : 'text-gray-400'}`}>
                                  +{data.points} pts
                                </span>
                              </div>
                            ))}
                            <div className="pt-2 border-t border-gray-200 flex justify-between font-bold text-sm">
                              <span>Total Score</span>
                              <span className="text-blue-600">{score}/100</span>
                            </div>
                          </div>
                        )}

                        {showingAnalysis && hasAnalysis && (
                          <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-lg p-5 mb-3 border border-purple-200">
                            <div className="flex items-center justify-between mb-4">
                              <h4 className="text-lg font-bold text-purple-900 flex items-center gap-2">
                                âœ¨ AI Analysis
                              </h4>
                              <button
                                onClick={() => toggleAnalysisPanel(opp.noticeId)}
                                className="text-gray-500 hover:text-gray-700 text-xl"
                              >
                                âœ•
                              </button>
                            </div>

                            <div className="space-y-4">
                              <div>
                                <h5 className="font-semibold text-purple-900 mb-2">Executive Summary</h5>
                                <p className="text-gray-700 text-sm leading-relaxed">{analyses[opp.noticeId].executiveSummary}</p>
                              </div>

                              <div>
                                <h5 className="font-semibold text-purple-900 mb-2">Key Requirements</h5>
                                <ul className="list-disc list-inside space-y-1 text-gray-700 text-sm">
                                  {Array.isArray(analyses[opp.noticeId].keyRequirements) ? (
                                    analyses[opp.noticeId].keyRequirements.map((req, idx) => (
                                      <li key={idx}>{req}</li>
                                    ))
                                  ) : (
                                    <li>{analyses[opp.noticeId].keyRequirements}</li>
                                  )}
                                </ul>
                              </div>

                              <div>
                                <h5 className="font-semibold text-purple-900 mb-2">Evaluation Criteria</h5>
                                <p className="text-gray-700 text-sm leading-relaxed">{analyses[opp.noticeId].evaluationCriteria}</p>
                              </div>

                              <div>
                                <h5 className="font-semibold text-purple-900 mb-2">Your Advantages</h5>
                                <p className="text-gray-700 text-sm leading-relaxed">{analyses[opp.noticeId].advantages}</p>
                              </div>

                              <div>
                                <h5 className="font-semibold text-purple-900 mb-2">Red Flags / Risks</h5>
                                <p className="text-gray-700 text-sm leading-relaxed">{analyses[opp.noticeId].redFlags}</p>
                              </div>

                              <div>
                                <h5 className="font-semibold text-purple-900 mb-2">Level of Effort</h5>
                                <p className="text-gray-700 text-sm leading-relaxed">{analyses[opp.noticeId].levelOfEffort}</p>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* FPDS Intelligence Panel */}
                        {showFPDS && fpdsInfo && (
                          <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-lg p-5 mb-3 border-2 border-indigo-200">
                            <div className="flex items-center justify-between mb-4">
                              <h4 className="text-lg font-bold text-indigo-900 flex items-center gap-2">
                                ðŸ” FPDS Market Intelligence
                              </h4>
                            </div>

                            {fpdsInfo.error ? (
                              <div className="text-sm text-gray-600">
                                Unable to load FPDS data: {fpdsInfo.error}
                              </div>
                            ) : fpdsInfo.count === 0 ? (
                              <div className="text-sm text-gray-600">
                                No historical contracts found for this NAICS + Agency combination in the last 2 years.
                              </div>
                            ) : (
                              <div className="space-y-4">
                                {/* Re-Compete Alerts - Show first if any exist */}
                                {fpdsInfo.recompeteAlerts && fpdsInfo.recompeteAlerts.totalExpiring > 0 && (
                                  <div className="bg-orange-50 border-2 border-orange-300 rounded-lg p-4">
                                    <h5 className="font-bold text-orange-900 mb-3 flex items-center gap-2">
                                      ðŸš¨ Re-Compete Alerts ({fpdsInfo.recompeteAlerts.totalExpiring})
                                    </h5>
                                    <p className="text-sm text-orange-800 mb-3">
                                      These contracts are expiring soon - reach out to the agency NOW to position for the re-compete!
                                    </p>
                                    
                                    {fpdsInfo.recompeteAlerts.expiring3Months.length > 0 && (
                                      <div className="mb-3">
                                        <div className="font-semibold text-red-900 text-sm mb-2">
                                          ðŸ”´ URGENT - Expiring in 0-3 months:
                                        </div>
                                        <div className="space-y-2">
                                          {fpdsInfo.recompeteAlerts.expiring3Months.map((contract, idx) => (
                                            <div key={idx} className="bg-white rounded p-3 border border-red-200 text-sm">
                                              <div className="flex justify-between items-start mb-1">
                                                <div className="font-medium text-gray-900 flex-1">
                                                  <span className="text-red-700">ðŸ“ {contract.monthsUntilExpiration} months left</span>
                                                  <div className="text-gray-700 mt-1">{contract.vendorName || 'Unknown Vendor'}</div>
                                                </div>
                                                <div className="text-right">
                                                  <div className="font-bold text-gray-900">{formatCurrency(contract.obligatedAmount)}</div>
                                                  <div className="text-xs text-gray-500">{contract.piid || 'N/A'}</div>
                                                </div>
                                              </div>
                                              <div className="text-xs text-gray-600 mt-1">
                                                Expires: {formatDate(contract.completionDate)}
                                              </div>
                                              {contract.description && (
                                                <div className="text-xs text-gray-500 mt-1 line-clamp-1">
                                                  {contract.description}
                                                </div>
                                              )}
                                            </div>
                                          ))}
                                        </div>
                                      </div>
                                    )}
                                    
                                    {fpdsInfo.recompeteAlerts.expiring6Months.length > 0 && (
                                      <div className="mb-3">
                                        <div className="font-semibold text-orange-900 text-sm mb-2">
                                          ðŸŸ  HIGH PRIORITY - Expiring in 3-6 months:
                                        </div>
                                        <div className="space-y-2">
                                          {fpdsInfo.recompeteAlerts.expiring6Months.slice(0, 3).map((contract, idx) => (
                                            <div key={idx} className="bg-white rounded p-3 border border-orange-200 text-sm">
                                              <div className="flex justify-between items-start mb-1">
                                                <div className="font-medium text-gray-900 flex-1">
                                                  <span className="text-orange-700">ðŸ“ {contract.monthsUntilExpiration} months left</span>
                                                  <div className="text-gray-700 mt-1">{contract.vendorName || 'Unknown Vendor'}</div>
                                                </div>
                                                <div className="text-right">
                                                  <div className="font-bold text-gray-900">{formatCurrency(contract.obligatedAmount)}</div>
                                                  <div className="text-xs text-gray-500">{contract.piid || 'N/A'}</div>
                                                </div>
                                              </div>
                                              <div className="text-xs text-gray-600 mt-1">
                                                Expires: {formatDate(contract.completionDate)}
                                              </div>
                                            </div>
                                          ))}
                                          {fpdsInfo.recompeteAlerts.expiring6Months.length > 3 && (
                                            <div className="text-xs text-gray-600 text-center py-1">
                                              + {fpdsInfo.recompeteAlerts.expiring6Months.length - 3} more expiring in this timeframe
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    )}
                                    
                                    {fpdsInfo.recompeteAlerts.expiring12Months.length > 0 && (
                                      <div>
                                        <div className="font-semibold text-yellow-900 text-sm mb-2">
                                          ðŸŸ¡ WATCH - Expiring in 6-12 months:
                                        </div>
                                        <div className="space-y-2">
                                          {fpdsInfo.recompeteAlerts.expiring12Months.slice(0, 2).map((contract, idx) => (
                                            <div key={idx} className="bg-white rounded p-2 border border-yellow-200 text-sm">
                                              <div className="flex justify-between items-start">
                                                <div className="flex-1">
                                                  <span className="text-yellow-700 text-xs">ðŸ“ ~{contract.monthsUntilExpiration} months</span>
                                                  <span className="text-gray-700 ml-2">{contract.vendorName || 'Unknown'}</span>
                                                </div>
                                                <div className="font-medium text-gray-900">{formatCurrency(contract.obligatedAmount)}</div>
                                              </div>
                                            </div>
                                          ))}
                                          {fpdsInfo.recompeteAlerts.expiring12Months.length > 2 && (
                                            <div className="text-xs text-gray-600 text-center py-1">
                                              + {fpdsInfo.recompeteAlerts.expiring12Months.length - 2} more expiring in this timeframe
                                            </div>
                                          )}
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                )}

                                {/* Historical Trends Section */}
                                {fpdsInfo.historicalTrends && fpdsInfo.historicalTrends.yearsAnalyzed >= 2 && (
                                  <div className="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                                    <h5 className="font-bold text-blue-900 mb-3 flex items-center gap-2">
                                      ðŸ“ˆ Market Trends Analysis
                                    </h5>
                                    
                                    {/* Trend Summary */}
                                    <div className="mb-3">
                                      {fpdsInfo.historicalTrends.trend === 'growing' && (
                                        <div className="flex items-center gap-2 bg-green-100 border border-green-300 rounded p-3">
                                          <span className="text-2xl">ðŸ“ˆ</span>
                                          <div className="flex-1">
                                            <div className="font-bold text-green-900">Growing Market</div>
                                            <div className="text-sm text-green-800">
                                              Spending increased by {Math.abs(fpdsInfo.historicalTrends.trendPercentage).toFixed(0)}% over recent years
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                      
                                      {fpdsInfo.historicalTrends.trend === 'declining' && (
                                        <div className="flex items-center gap-2 bg-red-100 border border-red-300 rounded p-3">
                                          <span className="text-2xl">ðŸ“‰</span>
                                          <div className="flex-1">
                                            <div className="font-bold text-red-900">Declining Market</div>
                                            <div className="text-sm text-red-800">
                                              Spending decreased by {Math.abs(fpdsInfo.historicalTrends.trendPercentage).toFixed(0)}% over recent years
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                      
                                      {fpdsInfo.historicalTrends.trend === 'stable' && (
                                        <div className="flex items-center gap-2 bg-gray-100 border border-gray-300 rounded p-3">
                                          <span className="text-2xl">ðŸ“Š</span>
                                          <div className="flex-1">
                                            <div className="font-bold text-gray-900">Stable Market</div>
                                            <div className="text-sm text-gray-700">
                                              Spending has remained relatively consistent ({Math.abs(fpdsInfo.historicalTrends.trendPercentage).toFixed(0)}% change)
                                            </div>
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                    
                                    {/* Year-by-Year Breakdown */}
                                    <div>
                                      <div className="font-semibold text-blue-900 text-sm mb-2">
                                        Spending by Year:
                                      </div>
                                      <div className="space-y-2">
                                        {fpdsInfo.historicalTrends.yearlyData.map((yearData, idx) => {
                                          const isCurrentYear = yearData.year === new Date().getFullYear();
                                          return (
                                            <div key={idx} className="bg-white rounded p-2 text-sm border border-blue-200">
                                              <div className="flex justify-between items-center mb-1">
                                                <span className="font-medium text-gray-900">
                                                  {yearData.year} {isCurrentYear && '(YTD)'}
                                                </span>
                                                <span className="font-bold text-blue-900">
                                                  {formatCurrency(yearData.totalValue)}
                                                </span>
                                              </div>
                                              <div className="flex justify-between text-xs text-gray-600">
                                                <span>{yearData.count} contract{yearData.count > 1 ? 's' : ''}</span>
                                                <span>Avg: {formatCurrency(yearData.avgValue)}</span>
                                              </div>
                                            </div>
                                          );
                                        })}
                                      </div>
                                    </div>
                                    
                                    {/* Strategic Insight */}
                                    <div className="mt-3 text-sm text-blue-800 bg-blue-100 rounded p-3">
                                      <strong>Strategic Insight:</strong>
                                      {fpdsInfo.historicalTrends.trend === 'growing' && (
                                        <span> This is an expanding market - agencies are increasing investment. Great time to pursue opportunities aggressively.</span>
                                      )}
                                      {fpdsInfo.historicalTrends.trend === 'declining' && (
                                        <span> This market is contracting - agencies are reducing spending. Focus on incumbent replacement and efficiency-driven proposals.</span>
                                      )}
                                      {fpdsInfo.historicalTrends.trend === 'stable' && (
                                        <span> This is a mature, stable market - consistent demand but moderate growth. Focus on differentiation and value-add services.</span>
                                      )}
                                    </div>
                                  </div>
                                )}

                                <div>
                                  <h5 className="font-semibold text-indigo-900 mb-2">ðŸ“Š Market Analysis (Historical Data)</h5>
                                  <div className="space-y-2">
                                    <div className="flex justify-between bg-white rounded p-2 text-sm">
                                      <span className="text-gray-700">Similar Contracts:</span>
                                      <strong className="text-indigo-900">{fpdsInfo.count}</strong>
                                    </div>
                                    {fpdsInfo.avgValue > 0 && (
                                      <>
                                        <div className="flex justify-between bg-white rounded p-2 text-sm">
                                          <span className="text-gray-700">Average Value:</span>
                                          <strong className="text-indigo-900">{formatCurrency(fpdsInfo.avgValue)}</strong>
                                        </div>
                                        {fpdsInfo.medianValue > 0 && (
                                          <div className="flex justify-between bg-white rounded p-2 text-sm">
                                            <span className="text-gray-700">Median Value:</span>
                                            <strong className="text-indigo-900">{formatCurrency(fpdsInfo.medianValue)}</strong>
                                          </div>
                                        )}
                                        {fpdsInfo.totalValue > 0 && (
                                          <div className="flex justify-between bg-white rounded p-2 text-sm">
                                            <span className="text-gray-700">Total Market Value:</span>
                                            <strong className="text-indigo-900">{formatCurrency(fpdsInfo.totalValue)}</strong>
                                          </div>
                                        )}
                                      </>
                                    )}
                                    {fpdsInfo.setAsidePercent > 0 && (
                                      <div className="flex justify-between bg-white rounded p-2 text-sm">
                                        <span className="text-gray-700">8(a) Set-Aside Rate:</span>
                                        <strong className="text-indigo-900">{fpdsInfo.setAsidePercent.toFixed(0)}%</strong>
                                      </div>
                                    )}
                                  </div>
                                </div>

                                {fpdsInfo.topWinners && fpdsInfo.topWinners.length > 0 && (
                                  <div>
                                    <h5 className="font-semibold text-indigo-900 mb-2">ðŸ¢ Top Winners (This NAICS + Agency)</h5>
                                    <div className="space-y-2">
                                      {fpdsInfo.topWinners.slice(0, 3).map((winner, idx) => (
                                        <div key={idx} className="flex justify-between bg-white rounded p-2 text-sm">
                                          <span className="text-gray-700">{idx + 1}. {winner.name}</span>
                                          <span className="text-indigo-900 font-medium">
                                            {winner.count} contract{winner.count > 1 ? 's' : ''} ({formatCurrency(winner.totalValue)})
                                          </span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>
                            )}
                          </div>
                        )}

                        {showFPDS && isFpdsLoading && (
                          <div className="bg-indigo-50 rounded-lg p-4 mb-3 border border-indigo-200">
                            <div className="flex items-center gap-2 text-indigo-700">
                              <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-indigo-700"></div>
                              <span className="text-sm">Loading FPDS market intelligence...</span>
                            </div>
                          </div>
                        )}
                        
                        <div className="flex flex-wrap gap-2">
                          {relevance.naics && (
                            <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                              âœ“ NAICS Match
                            </span>
                          )}
                          {relevance.setAside && (
                            <span className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                              âœ“ Set-Aside Match
                            </span>
                          )}
                          {relevance.agency && (
                            <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                              âœ“ Target Agency
                            </span>
                          )}
                          {relevance.contractValue && (
                            <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                              âœ“ In Value Range
                            </span>
                          )}
                          {relevance.responseTime && (
                            <span className="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded">
                              âœ“ Adequate Time
                            </span>
                          )}
                        </div>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                          <div className="text-xs text-gray-500">Agency</div>
                          <div className="text-sm font-medium text-gray-900">
                            {opp.department || opp.fullParentPathName || 'N/A'}
                          </div>
                        </div>

                        <div>
                          <div className="text-xs text-gray-500 mb-1">Response Deadline</div>
                          {(() => {
                            const countdown = getDeadlineCountdown(opp.responseDeadLine);
                            if (!countdown) {
                              return <div className="text-sm font-medium text-gray-900">N/A</div>;
                            }
                            return (
                              <div>
                                <div className={`inline-flex items-center gap-1 px-2 py-1 rounded border font-bold text-xs ${countdown.color}`}>
                                  <span>{countdown.icon}</span>
                                  <span>{countdown.urgency}</span>
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                  {formatDate(opp.responseDeadLine)}
                                </div>
                              </div>
                            );
                          })()}
                        </div>

                        <div>
                          <div className="text-xs text-gray-500">Award Amount</div>
                          <div className="text-sm font-medium text-gray-900">
                            {formatCurrency(opp.award?.amount)}
                          </div>
                        </div>

                        <div>
                          <div className="text-xs text-gray-500">Set-Aside</div>
                          <div className="text-sm font-medium text-gray-900">
                            {opp.typeOfSetAside || 'None'}
                          </div>
                        </div>
                      </div>

                      <div className="flex items-center justify-between pt-3 border-t border-gray-100">
                        <div className="flex items-center gap-4 text-xs text-gray-500">
                          <span>Notice ID: {opp.noticeId || 'N/A'}</span>
                          <span>â€¢</span>
                          <span>Posted: {formatDate(opp.postedDate)}</span>
                          {opp.naicsCode && (
                            <>
                              <span>â€¢</span>
                              <span>NAICS: {opp.naicsCode}</span>
                            </>
                          )}
                        </div>
                        {opp.noticeId && (
                          <a
                            href={`https://sam.gov/opp/${opp.noticeId}/view`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium inline-flex items-center gap-2"
                          >
                            View on SAM.gov
                            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                          </a>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>

              {(filtersEnabled ? filteredOpportunities : opportunities).length === 0 && !fetchLoading && !error && (
                <div className="text-center py-12 bg-white rounded-lg border border-gray-200">
                  <p className="text-gray-600">
                    {filtersEnabled 
                      ? 'No opportunities match your profile criteria. Try adjusting your filters or company profile.'
                      : 'No opportunities found'
                    }
                  </p>
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<FedPIE />, document.getElementById('root'));
  </script>
</body>
</html>